<div class="flex h-full">
  <!-- LEFT COLUMN: description / solution (unchanged) -->
  <aside class="flex flex-col" [style.flex]="'0 0 ' + (horizontalRatio() * 100) + '%'"
    style="min-width: 0; border-right: 1px solid var(--tw-border-opacity, #2d2d2d);">

    <!-- Tabs -->
    <div class="flex border-b bg-neutral-900 text-white">
      <button class="px-4 py-2 flex-1 text-left font-medium" [class.border-b-2]="activePanel() === 0"
        [class.text-blue-400]="activePanel() === 0" [class.text-gray-300]="activePanel() !== 0"
        (click)="activePanel.set(0)">
        Description
      </button>
      <button class="px-4 py-2 flex-1 text-left font-medium" [class.border-b-2]="activePanel() === 1"
        [class.text-blue-400]="activePanel() === 1" [class.text-gray-300]="activePanel() !== 1"
        (click)="activePanel.set(1)">
        Solution
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-auto p-6 bg-black text-white">
      <!-- Description Panel -->
      <div *ngIf="activePanel() === 0" class="space-y-4">
        <h1 class="text-2xl font-bold">{{ question()?.title }}</h1>
        <div class="text-sm text-gray-400 capitalize">{{ question()?.difficulty }}</div>
        <div class="whitespace-pre-wrap">{{ descriptionText() }}</div>

        <ng-container *ngIf="combinedExamples()">
          <div class="mt-6">
            <div class="flex items-center justify-between mb-2">
              <span class="text-xs uppercase font-semibold">Examples</span>
              <button
                class="flex items-center gap-1 bg-neutral-800 hover:bg-neutral-700 px-3 py-1 rounded text-sm border border-gray-600"
                (click)="copyExamples()">
                <ng-container *ngIf="!copiedExamples()">
                  <!-- copy icon -->
                  Copy
                </ng-container>
                <ng-container *ngIf="copiedExamples()">
                  <!-- check icon -->
                  Copied!
                </ng-container>
              </button>
            </div>
            <div class="h-48">
              <app-monaco-editor [code]="combinedExamples()"
                [language]="tech === 'angular' ? 'typescript' : 'javascript'" [readOnly]="true"
                class="h-full rounded border"
                [options]="{ minimap:{enabled:false}, lineNumbers:'on', folding:false }"></app-monaco-editor>
            </div>
          </div>
        </ng-container>
        <div>
          <button *ngIf="tech === 'angular'" pButton label="Preview what you need to build" icon="pi pi-eye"
            class="mt-6" (click)="openPreview()">
          </button>
        </div>
      </div>

      <p-dialog [(visible)]="previewVisible" [modal]="true" [dismissableMask]="true" [closable]="false"
        [draggable]="false" [resizable]="false" [style]="{ width: '90vw', maxWidth: '1400px' }"
        [contentStyle]="{ padding: '0', height: '80vh' }">
        <!-- custom header with close -->
        <ng-template pTemplate="header">
          <div class="flex items-center justify-between w-full">
            <div class="font-semibold">Preview</div>
            <button pButton icon="pi pi-times" class="p-button-text" (click)="closePreview()"></button>
          </div>
        </ng-template>

        <div class="w-full h-full">
          <iframe *ngIf="previewOnlyUrl" class="w-full h-full border-0" [src]="previewOnlyUrl"
            allow="accelerometer; autoplay; camera; encrypted-media; geolocation;"
            sandbox="allow-forms allow-modals allow-popups allow-scripts allow-same-origin"></iframe>
        </div>
      </p-dialog>

      <!-- Solution Panel -->
      <div *ngIf="activePanel() === 1" class="space-y-4">
        <h2 class="text-xl font-semibold">Solution Explanation</h2>
        <div class="whitespace-pre-wrap">{{ question()?.solution }}</div>
        <button pButton label="Load Solution Code" icon="pi pi-code" (click)="showSolution()"></button>
      </div>
    </div>

    <!-- Footer nav -->
    <div class="flex-none p-4 border-t bg-neutral-800 text-white flex justify-between">
      <button pButton label="← Prev" icon="pi pi-arrow-left" (click)="prev()"></button>
      <span>{{ progressText }}</span>
      <button pButton label="Next →" icon="pi pi-arrow-right" iconPos="right" (click)="next()"></button>
    </div>
  </aside>

  <!-- VERTICAL SPLITTER -->
  <div class="w-1 cursor-col-resize bg-gray-700" (pointerdown)="startHorizontalDrag($event)" style="user-select: none;">
  </div>

  <!-- RIGHT COLUMN: either SkyStackBlitz embed (Angular) or your existing JS editor/tests UI -->
  <main class="flex-1 flex flex-col overflow-hidden bg-gray-800 text-white">

    <!-- ANGULAR EMBED -->
    <ng-container *ngIf="tech === 'angular'">
      <div class="flex-1 flex flex-col">
        <!-- iframe area -->
        <div class="relative flex-1">
          <iframe *ngIf="embedUrl()" [src]="embedUrl()" class="w-full h-full border-0"
            allow="accelerometer; ambient-light-sensor; autoplay; camera; encrypted-media; geolocation;"
            sandbox="allow-forms allow-modals allow-popups allow-scripts allow-same-origin" (load)="onEmbedLoad()">
          </iframe>

          <!-- overlay spinner -->
          <div *ngIf="embedLoading()" class="absolute inset-0 grid place-items-center bg-black/40">
            <p-progressSpinner strokeWidth="4"></p-progressSpinner>
          </div>
        </div>

        <!-- Action bar (same look as JS, but tests disabled) -->
        <div class="flex-none p-4 border-t bg-neutral-900 flex justify-between items-center">
          <div class="text-sm opacity-70">
            Angular preview auto-reloads on changes in StackBlitz.
          </div>

          <button pButton label="Mark as complete" icon="pi pi-check" (click)="submitCode()">
          </button>
        </div>
      </div>
    </ng-container>



    <!-- JAVASCRIPT EDITOR & TESTS (unchanged) -->
    <ng-container *ngIf="tech !== 'angular'">
      <!-- Top tabs -->
      <div class="flex border-b bg-neutral-900 px-4">
        <button class="px-4 py-2" [class.opacity-100]="isTopCodeTab()" [class.opacity-60]="!isTopCodeTab()"
          (click)="topTab.set('code')">&lt;/&gt; Code</button>
        <button class="px-4 py-2" [class.opacity-100]="isTopTestsTab()" [class.opacity-60]="!isTopTestsTab()"
          (click)="topTab.set('tests')">⚗️ Test cases</button>
      </div>

      <!-- Split container -->
      <div #splitContainer class="flex-1 flex flex-col overflow-hidden">
        <!-- Editor / Tests -->
        <div class="overflow-hidden" [style.flex]="'0 0 ' + (editorRatio() * 100) + '%'" style="min-height: 120px;">
          <app-monaco-editor *ngIf="isTopCodeTab()" class="h-full" [code]="editorContent()" [language]="'javascript'"
            (codeChange)="editorContent.set($event)"></app-monaco-editor>
          <app-monaco-editor *ngIf="isTopTestsTab()" class="h-full" [code]="testCode()" [language]="'javascript'"
            (codeChange)="testCode.set($event)"></app-monaco-editor>
        </div>

        <!-- HORIZONTAL SPLITTER -->
        <div class="h-1 cursor-row-resize bg-gray-700" (pointerdown)="startDrag($event)" style="user-select: none;">
        </div>

        <!-- Results / Console -->
        <div class="flex-1 flex flex-col overflow-hidden">
          <!-- Action bar -->
          <div class="flex-none p-4 border-t bg-neutral-900 flex justify-between items-center">
            <button pButton label="Run Tests" icon="pi pi-flask" (click)="runTests()"></button>
            <div class="text-sm" *ngIf="hasRunTests">
              Passed: <strong>{{ passedCount() }}</strong>/<strong>{{ totalCount() }}</strong>
            </div>
            <button pButton label="Submit" icon="pi pi-check" (click)="submitCode()"></button>
          </div>

          <!-- Sub-tabs -->
          <div class="flex-none border-b bg-neutral-900">
            <button class="px-4 py-2 border-b-2" [class.border-blue-500]="isTestsTab()"
              (click)="subTab.set('tests')">Tests</button>
            <button class="px-4 py-2 border-b-2" [class.border-blue-500]="isConsoleTab()"
              (click)="subTab.set('console')">Console</button>
          </div>

          <!-- Panels -->
          <div class="flex-1 overflow-auto p-4 flex flex-col">
            <!-- Tests -->
            <div *ngIf="isTestsTab()" class="flex-1 overflow-auto">
              <div *ngIf="hasRunTests" class="mb-3 flex items-center gap-2">
                <strong>{{ passedCount() }}</strong> / <strong>{{ totalCount() }}</strong> passed
                <ng-container *ngIf="totalCount() > 0">
                  <span *ngIf="allPassing()" class="text-green-500 ml-2">Correct ✓</span>
                  <span *ngIf="!allPassing()" class="text-red-500 ml-2">Wrong answer ❌</span>
                </ng-container>
                <ng-container *ngIf="totalCount() === 0">
                  <span class="text-yellow-400 ml-2">No tests reported</span>
                </ng-container>
              </div>
              <div class="space-y-2">
                <div *ngFor="let t of testResults()" class="p-2 rounded border"
                  [ngClass]="t.passed ? 'border-green-500 bg-green-100/20' : 'border-red-500 bg-red-100/20'">
                  <div class="flex justify-between">
                    <div><strong>{{ t.passed ? '✅' : '❌' }} {{ t.name }}</strong></div>
                  </div>
                  <div *ngIf="t.error" class="mt-1 text-sm text-red-300">{{ t.error }}</div>
                </div>
              </div>
            </div>

            <!-- Console -->
            <div [style.display]="isConsoleTab() ? 'flex' : 'none'" class="h-full flex flex-col">
              <app-console-logger class="flex-1"></app-console-logger>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

  </main>
</div>