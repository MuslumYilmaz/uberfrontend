<div class="flex h-full">
  <!-- LEFT COLUMN -->
  <aside class="w-80 border-r flex flex-col">
    <p-accordion class="flex-1 overflow-auto" [multiple]="false" [activeIndex]="activePanel()">
      <p-accordionTab header="Problem Description">
        <div class="whitespace-pre-wrap">{{ question()?.description }}</div>
      </p-accordionTab>
      <p-accordionTab header="Solution Explanation">
        <div class="whitespace-pre-wrap">{{ question()?.solution }}</div>
        <button pButton label="Load Solution Code" icon="pi pi-code" class="mt-3" (click)="showSolution()">
        </button>
      </p-accordionTab>
      <p-accordionTab header="Test Cases">
        <ul class="list-disc pl-5">
          <li *ngFor="let t of question()?.tags">{{ t }}</li>
        </ul>
      </p-accordionTab>
    </p-accordion>
    <div class="flex-none p-4 border-t flex items-center justify-between">
      <button pButton label="← Prev" icon="pi pi-arrow-left" (click)="prev()" [disabled]="currentIndex === 0"></button>
      <span>{{ progressText }}</span>
      <button pButton label="Next →" icon="pi pi-arrow-right" iconPos="right" (click)="next()"
        [disabled]="currentIndex + 1 >= allQuestions.length"></button>
    </div>
  </aside>

  <!-- RIGHT COLUMN -->
  <main class="flex-1 flex flex-col overflow-hidden bg-white dark:bg-gray-900">
    <!-- Top tabs for code / test cases -->
    <div class="flex border-b">
      <button class="px-4 py-2 border-b-2" [class.border-blue-600]="isTopCodeTab()"
        [class.text-blue-600]="isTopCodeTab()" [class.text-gray-600]="!isTopCodeTab()" (click)="topTab.set('code')">
        Code
      </button>
      <button class="px-4 py-2 border-b-2" [class.border-blue-600]="isTopTestsTab()"
        [class.text-blue-600]="isTopTestsTab()" [class.text-gray-600]="!isTopTestsTab()" (click)="topTab.set('tests')">
        Test Cases
      </button>
    </div>

    <!-- Editor area with resize -->
    <div #splitContainer class="flex-1 flex flex-col overflow-hidden">
      <!-- Editor/Test code area -->
      <div class="overflow-hidden" [style.flex]=" '0 0 ' + (editorRatio() * 100) + '%'" style="min-height: 120px;">
        <div class="h-full relative">
          <div *ngIf="isTopCodeTab()" class="h-full">
            <app-monaco-editor class="h-full" [code]="editorContent()"
              [language]="tech === 'angular' ? 'typescript' : 'javascript'"
              (codeChange)="editorContent.set($event)"></app-monaco-editor>
          </div>
          <div *ngIf="isTopTestsTab()" class="h-full">
            <app-monaco-editor class="h-full" [code]="testCode()" [language]="'javascript'"
              (codeChange)="testCode.set($event)"></app-monaco-editor>
          </div>
        </div>
      </div>

      <!-- splitter bar -->
      <div class="h-1 cursor-row-resize bg-gray-300" (pointerdown)="startDrag($event)" style="user-select: none;"></div>

      <!-- Results and console -->
      <div class="flex-1 flex flex-col overflow-hidden">
        <!-- Action bar -->
        <div class="flex-none p-4 border-t bg-gray-50 flex justify-between items-center">
          <div class="flex gap-2 items-center">
            <button pButton label="Run Tests" icon="pi pi-flask" (click)="runTests()"></button>
            <div class="text-sm" *ngIf="hasRunTests">
              Passed: <strong>{{ passedCount() }}</strong> / <strong>{{ totalCount() }}</strong>
            </div>
          </div>
          <div>
            <button pButton label="Submit" icon="pi pi-check" (click)="submitCode()"></button>
          </div>
        </div>

        <!-- Sub-tabs for results -->
        <div class="flex-none border-b flex">
          <button class="px-4 py-2 border-b-2" [class.border-blue-600]="isTestsTab()"
            [class.text-blue-600]="isTestsTab()" [class.text-gray-600]="!isTestsTab()" (click)="subTab.set('tests')">
            Tests
          </button>
          <button class="px-4 py-2 border-b-2" [class.border-blue-600]="isConsoleTab()"
            [class.text-blue-600]="isConsoleTab()" [class.text-gray-600]="!isConsoleTab()"
            (click)="subTab.set('console')">
            Console
          </button>
        </div>

        <!-- Result panes -->
        <div class="flex-1 overflow-auto p-4 flex flex-col">
          <!-- Tests panel -->
          <!-- Summary bar above test list -->
          <div *ngIf="isTestsTab()" class="flex-1 overflow-auto">
            <div *ngIf="hasRunTests" class="mb-3 flex items-center gap-2">
              <strong>{{ passedCount() }}</strong> / <strong>{{ totalCount() }}</strong> passed
              <ng-container *ngIf="totalCount() > 0">
                <span *ngIf="allPassing()" class="text-green-600 ml-2">Correct ✓</span>
                <span *ngIf="!allPassing()" class="text-red-600 ml-2">Wrong answer ❌</span>
              </ng-container>
              <ng-container *ngIf="totalCount() === 0">
                <span class="text-yellow-500 ml-2">No tests reported</span>
              </ng-container>
            </div>

            <div class="space-y-2">
              <div *ngFor="let t of testResults()" class="p-2 rounded border"
                [ngClass]="t.passed ? 'border-green-500 bg-green-100' : 'border-red-500 bg-red-100'">
                <div class="flex justify-between">
                  <div><strong>{{ t.passed ? '✅' : '❌' }} {{ t.name }}</strong></div>
                </div>
                <div *ngIf="t.error" class="mt-1 text-sm text-red-700">{{ t.error }}</div>
              </div>
            </div>
          </div>


          <!-- Console panel -->
          <div class="h-full flex flex-col" [style.display]="isConsoleTab() ? 'flex' : 'none'">
            <app-console-logger class="flex-1"></app-console-logger>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>