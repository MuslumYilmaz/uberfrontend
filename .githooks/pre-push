#!/usr/bin/env bash
set -euo pipefail

# Ensure common Node paths are available in non-interactive git hooks.
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# Load nvm/asdf/fnm if present (git hooks don't source shell profiles).
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  . "$HOME/.nvm/nvm.sh"
fi
if [ -s "$HOME/.asdf/asdf.sh" ]; then
  . "$HOME/.asdf/asdf.sh"
fi
if command -v fnm >/dev/null 2>&1; then
  eval "$(fnm env --use-on-cd)"
fi

# Fallback: add the first nvm-installed node bin to PATH if npm is still missing.
if ! command -v npm >/dev/null 2>&1; then
  for p in "$HOME/.nvm/versions/node"/*/bin; do
    if [ -x "$p/npm" ]; then
      export PATH="$p:$PATH"
      break
    fi
  done
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "[pre-push] ERROR: npm not found. Install Node.js/npm and retry." >&2
  exit 1
fi

ZERO_SHA="0000000000000000000000000000000000000000"
CHANGED_FILES="$(mktemp)"
BEFORE_STATE="$(mktemp)"
AFTER_STATE="$(mktemp)"
trap 'rm -f "$CHANGED_FILES" "$BEFORE_STATE" "$AFTER_STATE"' EXIT

# Collect file paths included in the refs that are being pushed.
while read -r local_ref local_sha remote_ref remote_sha; do
  [ -z "${local_ref:-}" ] && continue

  # Branch deletion.
  if [ "$local_sha" = "$ZERO_SHA" ]; then
    continue
  fi

  if [ "$remote_sha" = "$ZERO_SHA" ]; then
    # New branch/tag push: include commits not already present on remotes.
    mapfile -t commits < <(git rev-list "$local_sha" --not --remotes 2>/dev/null || true)
    if [ "${#commits[@]}" -eq 0 ]; then
      commits=("$local_sha")
    fi
    for commit in "${commits[@]}"; do
      git diff-tree --no-commit-id --name-only -r "$commit" >> "$CHANGED_FILES" || true
    done
  else
    git diff --name-only "$remote_sha" "$local_sha" >> "$CHANGED_FILES" || true
  fi
done

sort -u -o "$CHANGED_FILES" "$CHANGED_FILES"

if grep -Eq '^frontend/src/assets/questions/(javascript|react|angular|vue|html|css)/(coding|trivia)\.json$' "$CHANGED_FILES"; then
  echo "[pre-push] Detected question-bank JSON changes. Running importance rubric apply..."

  git status --porcelain -- frontend/src/assets/questions | LC_ALL=C sort > "$BEFORE_STATE"

  if ! node frontend/scripts/score-importance-rubric.mjs \
    --tech javascript,react,angular,vue,html,css \
    --report /tmp/importance-rubric-pre-push.report.json \
    --apply; then
    echo "[pre-push] ERROR: importance rubric apply failed. Push aborted." >&2
    exit 1
  fi

  git status --porcelain -- frontend/src/assets/questions | LC_ALL=C sort > "$AFTER_STATE"
  if ! cmp -s "$BEFORE_STATE" "$AFTER_STATE"; then
    echo "[pre-push] ERROR: importance updates changed question JSON files." >&2
    echo "[pre-push] Commit generated updates, then push again." >&2
    git status --short -- frontend/src/assets/questions >&2 || true
    exit 1
  fi

  echo "[pre-push] OK: importance values already up-to-date."
fi

echo "[pre-push] Running FrontendAtlas unit tests (Karma)..."

if ! npm -C frontend run test; then
  echo "[pre-push] ERROR: Unit tests failed. Push aborted." >&2
  exit 1
fi

echo "[pre-push] OK: Unit tests passed."
echo "[pre-push] Running FrontendAtlas E2E tests (Playwright)..."

# Run Playwright E2E (starts dev server via playwright.config.ts webServer)
if ! PLAYWRIGHT_WEB_SERVER=1 npm -C frontend run test:e2e; then
  echo "[pre-push] ERROR: E2E tests failed. Push aborted." >&2
  exit 1
fi

echo "[pre-push] OK: E2E tests passed."
