#!/usr/bin/env bash
set -euo pipefail

# Ensure common Node paths are available in non-interactive git hooks.
export PATH="/opt/homebrew/bin:/usr/local/bin:$PATH"

# Load nvm/asdf/fnm if present (git hooks don't source shell profiles).
if [ -s "$HOME/.nvm/nvm.sh" ]; then
  . "$HOME/.nvm/nvm.sh"
fi
if [ -s "$HOME/.asdf/asdf.sh" ]; then
  . "$HOME/.asdf/asdf.sh"
fi
if command -v fnm >/dev/null 2>&1; then
  eval "$(fnm env --use-on-cd)"
fi

# Fallback: add the first nvm-installed node bin to PATH if npm is still missing.
if ! command -v npm >/dev/null 2>&1; then
  for p in "$HOME/.nvm/versions/node"/*/bin; do
    if [ -x "$p/npm" ]; then
      export PATH="$p:$PATH"
      break
    fi
  done
fi

if ! command -v npm >/dev/null 2>&1; then
  echo "[pre-push] ERROR: npm not found. Install Node.js/npm and retry." >&2
  exit 1
fi

SYNC_DIFF="$(mktemp)"
trap 'rm -f "$SYNC_DIFF"' EXIT

echo "[pre-push] Verifying frontend assets/questions and cdn/questions are in sync..."
if ! diff -qr frontend/src/assets/questions cdn/questions > "$SYNC_DIFF"; then
  echo "[pre-push] ERROR: cdn/questions is out of sync with frontend/src/assets/questions." >&2
  echo "[pre-push] Sync command: rsync -a --delete frontend/src/assets/questions/ cdn/questions/" >&2
  echo "[pre-push] Differences (first 50):" >&2
  sed -n '1,50p' "$SYNC_DIFF" >&2 || true
  exit 1
fi
echo "[pre-push] OK: cdn/questions is in sync."

# Legacy importance rubric tooling was removed. Keep hook aligned with active workflow.

echo "[pre-push] Running FrontendAtlas unit tests (Karma)..."

if ! npm -C frontend run test; then
  echo "[pre-push] ERROR: Unit tests failed. Push aborted." >&2
  exit 1
fi

echo "[pre-push] OK: Unit tests passed."
echo "[pre-push] Running FrontendAtlas E2E tests (Playwright)..."

# Run Playwright E2E (starts dev server via playwright.config.ts webServer)
if ! PLAYWRIGHT_WEB_SERVER=1 npm -C frontend run test:e2e; then
  echo "[pre-push] ERROR: E2E tests failed. Push aborted." >&2
  exit 1
fi

echo "[pre-push] OK: E2E tests passed."
