<div class="coding-shell mx-auto max-w-7xl px-4 py-6" data-testid="coding-list-page">
  <header class="fa-page-header">
    <p class="fa-page-kicker">Practice library</p>
    <h1 class="fa-page-title">All questions</h1>
    <p class="fa-page-subtitle fa-body">Explore every prompt and slice the library by difficulty, tech, or tags.</p>
  </header>

  <app-coding-tech-kind-tabs *ngIf="source!=='company'" [source]="source" [techTabs]="techTabs" [kindTabs]="kindTabs"
    [tech]="tech" [kind]="kind" [viewMode]="viewMode" [selectedTech]="selectedTech$ | async"
    [selectedKind]="selectedKind$ | async" [selectedCategory]="selectedCategory$ | async"
    [isSystemCategoryActive]="(isSystemCategoryActive$ | async) ?? false"
    [filteredCount]="(filteredCount$ | async) || 0" [navQueryParams]="tabsQueryParams()" (techSelected)="toggleTech($event)"
    (categoryToggled)="toggleCategory($event)" (kindSelected)="selectKind($event)">
  </app-coding-tech-kind-tabs>

  <div class="fa-questions-layout">
    <aside class="fa-filter-panel fa-card fa-card--elevated" aria-label="Filters">
      <div class="fa-filter-panel__header">
        <div>
          <p class="fa-filter-panel__eyebrow fa-meta-label">All Questions</p>
          <h2 class="fa-filter-panel__title fa-section-title">Refine the list</h2>
        </div>
        <div class="fa-filter-panel__count">
          <span class="pill fa-chip fa-chip--label">{{ (filteredCount$ | async) || 0 }} items</span>
        </div>
      </div>

      <div class="fa-filter-section">
        <div class="fa-filter-section__title fa-meta-label">Difficulty</div>
        <div class="fa-filter-options">
          <label *ngFor="let opt of difficultyOptions" class="fa-filter-option"
            [attr.data-testid]="'filter-difficulty-' + opt.value">
            <input type="checkbox" [checked]="((diffs$ | async) || []).includes(opt.value)"
              (change)="onDiffChange(opt.value, $event)">
            <span class="fa-chip fa-chip--label fa-filter-chip">
              <span class="fa-filter-chip__icon" aria-hidden="true">⬤</span>
              {{ opt.label }}
            </span>
          </label>
        </div>
      </div>

      <div class="fa-filter-section">
        <div class="fa-filter-section__title fa-meta-label">Importance</div>
        <div class="fa-filter-options">
          <label class="fa-filter-option" data-testid="filter-importance-low">
            <input type="checkbox" [checked]="((impTiers$ | async) || []).includes('low')"
              (change)="onImpChange('low', $event)">
            <span class="fa-chip fa-chip--label fa-filter-chip">
              <span class="fa-filter-chip__icon" aria-hidden="true">△</span>
              Low
            </span>
          </label>
          <label class="fa-filter-option" data-testid="filter-importance-medium">
            <input type="checkbox" [checked]="((impTiers$ | async) || []).includes('medium')"
              (change)="onImpChange('medium', $event)">
            <span class="fa-chip fa-chip--label fa-filter-chip">
              <span class="fa-filter-chip__icon" aria-hidden="true">▣</span>
              Medium
            </span>
          </label>
          <label class="fa-filter-option" data-testid="filter-importance-high">
            <input type="checkbox" [checked]="((impTiers$ | async) || []).includes('high')"
              (change)="onImpChange('high', $event)">
            <span class="fa-chip fa-chip--label fa-filter-chip">
              <span class="fa-filter-chip__icon" aria-hidden="true">▲</span>
              High
            </span>
          </label>
        </div>
      </div>

      <div class="fa-filter-section" *ngIf="source === 'global-coding'">
        <div class="fa-filter-section__title fa-meta-label">Technologies</div>
        <div class="fa-filter-options fa-filter-options--pills">
          <button *ngFor="let tab of techTabs" type="button" class="fa-chip fa-chip--accent fa-tech-pill"
            [attr.data-testid]="'filter-tech-' + tab.key"
            [class.is-active]="(selectedTech$ | async) === tab.key" (click)="toggleTech(tab.key)">
            <span class="fa-tech-pill__badge">{{ tab.badge }}</span>
            <span class="fa-tech-pill__label">{{ tab.label }}</span>
          </button>
        </div>
      </div>

      <div class="fa-filter-section" *ngIf="(popularTags$ | async) as tagList">
        <div class="fa-filter-section__header">
          <div class="fa-filter-section__title fa-meta-label">Tags</div>
          <div class="fa-filter-section__actions">
            <button type="button" class="fa-btn fa-btn--ghost fa-toggle" (click)="toggleTagMatchMode()">
              Match {{ tagMatchMode === 'all' ? 'all' : 'any' }}
            </button>
            <button type="button" class="fa-btn fa-btn--ghost fa-link-btn"
              [disabled]="!((selectedTags$ | async)?.length)" (click)="clearAllTags()">
              Clear
            </button>
          </div>
        </div>
        <div class="fa-chip-rail" role="listbox" aria-label="Filter by tags">
          <fa-chip *ngFor="let tag of tagList" class="fa-chip--topic tag-chip" size="sm"
            [selected]="((selectedTags$ | async) || []).includes(tag)" (selectedChange)="toggleTag(tag)">
            <span class="chip-icon" aria-hidden="true">#</span>
            {{ tag }}
          </fa-chip>
        </div>
      </div>
    </aside>

    <section class="fa-question-list">
      <div class="fa-question-list__controls">
        <div class="fa-question-list__search fa-input">
          <i class="pi pi-search"></i>
          <input pInputText type="text" placeholder="Search questions" [(ngModel)]="searchTerm"
            data-testid="coding-list-search"
            (ngModelChange)="onSearchTermChange($event)" [ngModelOptions]="{ standalone: true }" />
        </div>

        <div class="fa-question-list__actions">
          <div class="fa-count-badge">
            {{ (filteredCount$ | async) || 0 }} matches
          </div>
          <ng-container *ngIf="sort$ | async as currentSort">
            <div class="fa-sort sort-wrap" (keydown.escape)="closeSort()" [class.open]="sortOpen">
              <button type="button" class="fa-sort__trigger sort-btn fa-btn fa-btn--ghost" (click)="toggleSort()"
                data-testid="coding-list-sort-trigger">
                <span class="fa-sort__label">
                  {{ currentSortLabel(currentSort) }}
                </span>
                <i class="pi pi-chevron-down" [class.up]="sortOpen"></i>
              </button>

              <div class="fa-sort__menu sort-menu" *ngIf="sortOpen">
                <button *ngFor="let opt of sortOptions" type="button"
                  [attr.data-testid]="'coding-list-sort-' + opt.key"
                  class="fa-sort__item sort-item fa-btn fa-btn--ghost" [class.active]="opt.key === currentSort"
                  (click)="setSort(opt.key)">
                  <span class="fa-sort__text">{{ opt.label }}</span>
                  <span class="fa-sort__check">✓</span>
                </button>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <div class="list">
        <ng-container *ngIf="visible$ | async as questions; else loading">
          <div *ngIf="questions.length === 0" class="py-6 text-center text-gray-500">
            <div class="italic" data-testid="coding-empty-state">No questions match your filters.</div>
            <button type="button" class="fa-btn fa-btn--ghost fa-link-btn mt-3" data-testid="coding-empty-reset"
              (click)="resetAllFilters()">
              Reset filters
            </button>
          </div>

          <a *ngFor="let q of questions"
            class="list-row fa-card fa-card--interactive fa-question-card fa-question-card--compact"
            [attr.data-testid]="'question-card-' + q.id"
            [class.is-solved]="auth.isLoggedIn() && solvedSet().has(q.id)"
            [class.is-locked]="isLocked(q)"
            [attr.aria-disabled]="isLocked(q) ? true : null"
            [routerLink]="linkTo(q)"
            (click)="handleCardClick($event, q)"
            [state]="stateForNav(questions, q, (companySlug$ | async) || null)">
            <div class="fa-question-card__grid">
              <div class="fa-question-card__main">
                <div class="fa-question-card__eyebrow">
                  <span class="eyebrow-dot"></span>
                  <span>{{ q.__kind === 'trivia' ? 'Quiz' : 'Coding' }} prompt</span>
                  <span class="premium-pill" *ngIf="isLocked(q)">Premium</span>
                </div>
                <div class="fa-question-card__title fa-card-title">{{ q.title }}</div>
                <div class="solved-pill" *ngIf="auth.isLoggedIn() && solvedSet().has(q.id)" aria-label="Solved">
                  <i class="pi pi-check"></i>
                  <span>Solved</span>
                </div>

                <div class="fa-question-card__description fa-meta-text desc-tip-target" [pTooltip]="descriptionText(q)"
                  tooltipPosition="bottom" appendTo="body" [tooltipStyleClass]="'desc-tip'" [showDelay]="150"
                  [hideDelay]="0" [autoHide]="true" [life]="0" [escape]="false" [tooltipDisabled]="!descriptionText(q)"
                  tabindex="0">
                  {{ preview(descriptionText(q), 120) }}
                </div>

                <div class="framework-switcher" *ngIf="frameworkOptions(q).length > 1">
                  <div class="fw-label-row">
                    <span class="fw-label">Framework versions</span>
                    <span class="fw-hint">Open this challenge in your stack</span>
                  </div>
                  <div class="fw-chip-row">
                    <button *ngFor="let opt of frameworkOptions(q)" type="button" class="fw-chip"
                      [class.active]="opt.id === q.id" [attr.aria-label]="'Open '+frameworkLabel(opt.tech)+' version'"
                      (click)="goToFramework($event, opt, q)">
                      <span class="fw-chip-label">{{ frameworkLabel(opt.tech) }}</span>
                      <span class="fw-cta">Open</span>
                    </button>
                  </div>
                </div>
              </div>

              <div class="fa-question-card__meta-row">
                <div class="fa-question-card__meta-item" *ngIf="auth.isLoggedIn() && solvedSet().has(q.id)">
                  <span class="fa-meta-label">Status</span>
                  <span class="fa-chip fa-chip--status">
                    <i class="pi pi-check" aria-hidden="true"></i>
                    Solved
                  </span>
                </div>

                <div class="fa-question-card__meta-item">
                  <span class="fa-meta-label">Difficulty</span>
                  <span class="fa-chip fa-chip--difficulty" [attr.data-difficulty]="q.difficulty">
                    {{ q.difficulty | titlecase }}
                  </span>
                </div>

                <div class="fa-question-card__meta-item">
                  <span class="fa-meta-label">Importance</span>
                  <span class="fa-chip fa-chip--importance" [attr.data-importance]="impLabel(q)">
                    {{ impLabel(q) | titlecase }}
                  </span>
                </div>

                <div class="fa-question-card__meta-item" *ngIf="source!=='tech'">
                  <span class="fa-meta-label">Tech</span>
                  <span class="fa-chip fa-chip--tech">
                    <span class="chip-icon" aria-hidden="true">⟡</span>
                    {{ techName(q) }}
                  </span>
                </div>

                <span class="ghost-link meta-open fa-btn fa-btn--ghost">Open</span>
              </div>
            </div>
          </a>
        </ng-container>

        <ng-template #loading>
          <div class="py-10 flex justify-center">
            <p-progressSpinner styleClass="text-blue-500"></p-progressSpinner>
          </div>
        </ng-template>
      </div>

      <app-offline-banner></app-offline-banner>
    </section>
  </div>
</div>
