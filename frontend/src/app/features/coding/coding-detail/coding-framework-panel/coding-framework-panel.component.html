<div class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex-1 flex flex-col overflow-hidden relative">

    <!-- Draft update banner (versioned drafts) -->
    <app-draft-update-banner *ngIf="showUpdateBanner() && !isViewingOlderVersion()"
        [isVisible]="true" mode="updated" [otherDrafts]="availableOlderDrafts()"
        (openVersion)="openOlderDraft($event)" (copyVersion)="copyDraftIntoLatest($event)" (dismiss)="dismissDraftUpdateBanner()">
    </app-draft-update-banner>

    <app-draft-update-banner *ngIf="isViewingOlderVersion()"
        [isVisible]="true" mode="older"
        (switchToCurrent)="backToLatestDraft()" (copyVersion)="copyActiveDraftIntoLatest()">
    </app-draft-update-banner>

    <!-- Restore banner -->
    <app-restore-banner [isVisible]="showRestoreBanner()" [isSolution]="viewingSolution()"
        (reset)="viewingSolution() ? revertToUserCodeFromBanner() : resetToStarter()"
        (dismiss)="dismissRestoreBanner()">
    </app-restore-banner>

    <!-- File Drawer -->
    <div class="file-drawer" [class.open]="showFileDrawer()">
        <div class="backdrop" (click)="closeFiles()"></div>
        <div class="panel">
            <div class="panel-header">
                <div>Files</div>
                <button class="icon-btn" title="Close" (click)="closeFiles()">
                    <i class="pi pi-times"></i>
                </button>
            </div>

            <div class="panel-body">
                <ul class="file-tree">
                    <ng-template #renderNodes let-nodes let-depth="depth">
                        <li *ngFor="let n of nodes">
                            <!-- FOLDER -->
                            <div *ngIf="n.type === 'dir'" class="tree-row folder-row"
                                [style.paddingLeft.px]="depth * 12 + 8" (click)="toggleDir(n.path)"
                                [class.open]="isOpen(n.path)">
                                <i class="pi pi-chevron-right caret"></i>
                                <i class="pi pi-folder folder-ico"></i>
                                <span class="name" [title]="n.path">{{ n.name }}</span>
                            </div>

                            <!-- CHILDREN -->
                            <ul *ngIf="isOpen(n.path)" class="children">
                                <ng-container *ngTemplateOutlet="renderNodes;
                             context: { $implicit: n.children, depth: depth + 1 }">
                                </ng-container>
                            </ul>

                            <!-- FILE -->
                            <div *ngIf="n.type === 'file'" class="tree-row file-row"
                                [class.active]="(openPath()||frameworkEntryFile)===n.path"
                                [style.paddingLeft.px]="depth * 12 + 28" (click)="openFile(n.path); closeFiles()"
                                [title]="n.path">
                                <i class="pi pi-file file-ico"></i>
                                <span class="name">{{ n.name }}</span>
                            </div>
                        </li>
                    </ng-template>

                    <ng-container *ngTemplateOutlet="renderNodes; context: { $implicit: treeRoots(), depth: 0 }">
                    </ng-container>
                </ul>
            </div>
        </div>
    </div>

    <!-- 2-col layout: editor + preview -->
    <div class="flex-1 flex min-h-0 framework-layout">
        <!-- LEFT: Editor -->
        <div class="min-w-0 min-h-0 flex flex-col" [style.flex]="frameworkEditorFlex()">
            <!-- editor header, tabs vs. -->
            <div class="flex items-center justify-between border-b border-white/10 px-2 py-1">
                <div class="flex items-center gap-3 min-w-0">
                    <button type="button" class="icon-btn" title="File tree" (click)="toggleFiles()">
                        <i class="pi pi-bars"></i>
                    </button>
                    <div class="min-w-0 leading-tight">
                        <div class="text-xs text-white truncate" [title]="currentPath() || 'Select a file'">
                            {{ currentFileLabel() }}
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <span *ngIf="viewingSolution()" class="text-[11px] text-yellow-300">Solution loaded</span>
                    <button type="button" class="text-xs px-3 py-1.5 rounded border border-white/20 hover:bg-white/5"
                        (click)="rebuildFrameworkPreview()">
                        Rebuild preview
                    </button>
                </div>
            </div>

            <section class="min-w-0 min-h-0 flex-1 flex editor-shell">
                <ng-container *ngIf="useMonaco(); else liteFrameworkEditor">
                    <app-monaco-editor class="flex-1 min-h-0 h-full editor-fill" [code]="editorContent()"
                        [language]="langFromPath(currentPath())" [modelKey]="currentPath()" [options]="editorOptions"
                        (codeChange)="onFrameworkCodeChange($event)" (ready)="onEditorReady()">
                    </app-monaco-editor>
                    <textarea
                        *ngIf="!editorReady()"
                        class="lite-editor editor-fill lite-overlay"
                        aria-label="Framework code editor"
                        [value]="editorContent()"
                        [attr.spellcheck]="false"
                        (input)="onFrameworkCodeChange($any($event.target).value)"></textarea>
                </ng-container>
                <ng-template #liteFrameworkEditor>
                    <textarea
                        class="lite-editor editor-fill"
                        aria-label="Framework code editor"
                        [value]="editorContent()"
                        [attr.spellcheck]="false"
                        (input)="onFrameworkCodeChange($any($event.target).value)"></textarea>
                </ng-template>
            </section>
        </div>

        <!-- VERTICAL SPLITTER (same idea as coding-detail) -->
        <div class="splitter" [class.dragging]="isDraggingFrameworkCols()"
            (pointerdown)="startFrameworkColsDrag($event)">
        </div>

        <!-- RIGHT: Preview iframe -->
        <div class="relative flex-1 min-w-0 min-h-0">
            <div *ngIf="showingFrameworkSolutionPreview()"
                class="absolute top-2 right-3 z-20 bg-yellow-300 text-black text-xs px-3 py-1.5 rounded shadow-sm flex items-center gap-3">
                <span class="font-medium">Showing solution preview</span>
                <button class="text-xs underline" (click)="closeSolutionPreview()">
                    Close preview
                </button>
            </div>

            <div *ngIf="loadingPreview()" class="preview-loading">
                <div class="spinner" aria-hidden="true"></div>
                <div class="loading-copy">
                    <div class="loading-title">Loading preview…</div>
                    <div class="loading-sub">This might take a few seconds.</div>
                </div>
            </div>

            <div *ngIf="!previewUrl()" class="absolute inset-0 grid place-items-center text-xs text-gray-400">
                No preview yet. Click “Rebuild preview”.
            </div>

            <iframe #previewFrame class="preview-frame absolute inset-0 w-full h-full border-0" title="Framework live preview" referrerpolicy="no-referrer"
                [class.is-loading]="loadingPreview()"
                sandbox="allow-scripts">
            </iframe>
        </div>
    </div>

</div>
