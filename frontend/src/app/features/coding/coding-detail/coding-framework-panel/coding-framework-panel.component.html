<div class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex-1 flex flex-col overflow-hidden relative">

    <!-- Restore banner -->
    <div *ngIf="showRestoreBanner()"
        class="restore-banner px-3 py-1.5 bg-yellow-200 text-black text-xs relative text-center">
        <span class="font-medium" *ngIf="viewingSolution(); else restoredMsg">
            You're viewing the solution code.
        </span>
        <ng-template #restoredMsg>
            <span class="font-medium">
                We loaded your last code from this browser.
            </span>
        </ng-template>

        <div class="absolute right-2 inset-y-0 flex items-center gap-3">
            <button *ngIf="viewingSolution()" class="underline font-medium" (click)="revertToUserCodeFromBanner()">
                Revert to your code
            </button>
            <button *ngIf="!viewingSolution()" class="underline font-medium" (click)="resetToStarter()">
                Reset to starter code
            </button>
            <button class="opacity-70 hover:opacity-100" (click)="dismissRestoreBanner()">✕</button>
        </div>
    </div>

    <!-- File Drawer -->
    <div class="file-drawer" [class.open]="showFileDrawer()">
        <div class="backdrop" (click)="closeFiles()"></div>
        <div class="panel">
            <div class="panel-header">
                <div>Files</div>
                <button class="icon-btn" title="Close" (click)="closeFiles()">
                    <i class="pi pi-times"></i>
                </button>
            </div>

            <div class="panel-body">
                <ul class="file-tree">
                    <ng-template #renderNodes let-nodes let-depth="depth">
                        <li *ngFor="let n of nodes">
                            <!-- FOLDER -->
                            <div *ngIf="n.type === 'dir'" class="tree-row folder-row"
                                [style.paddingLeft.px]="depth * 12 + 8" (click)="toggleDir(n.path)"
                                [class.open]="isOpen(n.path)">
                                <i class="pi pi-chevron-right caret"></i>
                                <i class="pi pi-folder folder-ico"></i>
                                <span class="name" [title]="n.path">{{ n.name }}</span>
                            </div>

                            <!-- CHILDREN -->
                            <ul *ngIf="isOpen(n.path)" class="children">
                                <ng-container *ngTemplateOutlet="renderNodes;
                             context: { $implicit: n.children, depth: depth + 1 }">
                                </ng-container>
                            </ul>

                            <!-- FILE -->
                            <div *ngIf="n.type === 'file'" class="tree-row file-row"
                                [class.active]="(openPath()||frameworkEntryFile)===n.path"
                                [style.paddingLeft.px]="depth * 12 + 28" (click)="openFile(n.path); closeFiles()"
                                [title]="n.path">
                                <i class="pi pi-file file-ico"></i>
                                <span class="name">{{ n.name }}</span>
                            </div>
                        </li>
                    </ng-template>

                    <ng-container *ngTemplateOutlet="renderNodes; context: { $implicit: treeRoots(), depth: 0 }">
                    </ng-container>
                </ul>
            </div>
        </div>
    </div>

    <!-- 2-col layout: editor + preview -->
    <div class="flex-1 grid grid-cols-2 gap-px min-h-0">
        <!-- LEFT: Editor -->
        <div class="min-w-0 min-h-0 flex flex-col">
            <div class="flex items-center justify-between border-b border-white/10 px-2 py-1">
                <div class="flex items-center gap-2 min-w-0">
                    <button class="icon-btn" [class.active]="showFileDrawer()" (click)="toggleFiles()"
                        aria-label="Toggle files" title="Files">
                        <i class="pi pi-bars"></i>
                    </button>
                    <div class="text-xs opacity-80 truncate" [title]="currentPath()">
                        {{ currentFileLabel() }}
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <button class="text-xs px-2 py-1 border border-white/10 rounded"
                        (click)="rebuildFrameworkPreview()">
                        Rebuild preview
                    </button>
                </div>
            </div>

            <section class="min-w-0 min-h-0 flex-1 flex">
                <app-monaco-editor class="flex-1 min-h-0 h-full editor-fill" [code]="editorContent()"
                    [language]="langFromPath(openPath() || frameworkEntryFile)" [options]="editorOptions"
                    (codeChange)="onFrameworkCodeChange($event)">
                </app-monaco-editor>
            </section>
        </div>

        <!-- RIGHT: Preview iframe -->
        <div class="relative min-w-0 min-h-0">
            <div *ngIf="showingFrameworkSolutionPreview()"
                class="absolute top-2 right-3 z-20 bg-yellow-300 text-black text-xs px-3 py-1.5 rounded shadow-sm flex items-center gap-3">
                <span class="font-medium">Showing solution preview</span>
                <button class="text-xs underline" (click)="closeSolutionPreview()">
                    Close preview
                </button>
            </div>

            <div *ngIf="!previewUrl()" class="absolute inset-0 grid place-items-center text-xs text-gray-400">
                No preview yet. Click “Rebuild preview”.
            </div>

            <iframe #previewFrame class="absolute inset-0 w-full h-full border-0 bg-white" referrerpolicy="no-referrer"
                sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation">
            </iframe>
        </div>
    </div>
</div>