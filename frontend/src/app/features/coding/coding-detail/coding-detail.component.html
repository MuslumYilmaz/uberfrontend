<!-- Fixed full-viewport work area -->
<div class="coding-detail fixed-under-header flex gap-[5px]">
  <!-- LEFT COLUMN -->
  <aside class="flex flex-col bg-neutral-900/95 rounded-lg shadow-sm border border-white/10 overflow-hidden"
    [style.flex]="asideFlex()" style="min-width:0;">
    <!-- Collapsed rail -->
    <div *ngIf="descCollapsed()" class="h-full w-full flex flex-col items-center justify-between py-2">
      <div class="flex flex-col items-center gap-2">
        <button pButton type="button" icon="pi pi-chevron-right" class="p-button-rounded p-button-text"
          (click)="toggleDescription()" aria-label="Expand description"></button>

        <button pButton type="button" icon="pi pi-file" class="p-button-rounded p-button-text"
          [ngClass]="{ 'text-white': activePanel()===0, 'opacity-60': activePanel()!==0 }"
          (click)="activePanel.set(0); toggleDescription()" aria-label="Description"></button>

        <button pButton type="button" icon="pi pi-code" class="p-button-rounded p-button-text"
          [ngClass]="{ 'text-white': activePanel()===1, 'opacity-60': activePanel()!==1 }"
          (click)="onSolutionTabClick()" aria-label="Solution"></button>
      </div>
      <div></div>
    </div>

    <!-- Expanded content -->
    <ng-container *ngIf="!descCollapsed()">
      <div class="flex items-center border-b border-white/10 text-white">
        <div class="flex-1 flex">
          <button class="px-4 py-2 flex-1 text-left font-medium" [class.border-b-2]="activePanel()===0"
            [class.text-blue-400]="activePanel()===0" [class.text-gray-300]="activePanel()!==0"
            (click)="activePanel.set(0)">Description</button>

          <button class="px-4 py-2 flex-1 text-left font-medium" [class.border-b-2]="activePanel()===1"
            [class.text-blue-400]="activePanel()===1" [class.text-gray-300]="activePanel()!==1"
            (click)="onSolutionTabClick()">Solution</button>
        </div>

        <button class="px-3 py-2 text-gray-300 hover:text-white p-button-text" pButton type="button"
          icon="pi pi-chevron-left" (click)="toggleDescription()" aria-label="Hide description"></button>
      </div>

      <div class="flex-1 overflow-auto p-6 text-white">
        <!-- Description Panel -->
        <div *ngIf="activePanel()===0" class="space-y-4">
          <h1 class="text-xl font-bold">{{ question()?.title }}</h1>
          <div class="text-xs text-gray-400 capitalize">{{ question()?.difficulty }}</div>

          <div class="whitespace-pre-wrap text-sm leading-6">
            {{ descriptionText() }}
          </div>

          <ng-container *ngIf="combinedExamples()">
            <div class="mt-6">
              <div class="flex items-center justify-between mb-2">
                <span class="text-xs uppercase font-semibold">Examples</span>
                <button
                  class="flex items-center gap-1 bg-neutral-800 hover:bg-neutral-700 px-3 py-1 rounded text-sm border border-gray-600"
                  (click)="copyExamples()">
                  <ng-container *ngIf="!copiedExamples()">Copy</ng-container>
                  <ng-container *ngIf="copiedExamples()">Copied!</ng-container>
                </button>
              </div>

              <div class="h-48 relative overflow-hidden">
                <app-monaco-editor class="h-full rounded border border-white/10 pointer-events-none select-none"
                  [code]="combinedExamples()" [language]="tech==='angular' ? 'typescript' : 'javascript'"
                  [readOnly]="true" [options]="examplesMonacoOptions">
                </app-monaco-editor>
              </div>
            </div>
          </ng-container>

          <div>
            <button *ngIf="tech==='angular'" pButton label="Preview what you need to build" icon="pi pi-eye"
              class="mt-6" (click)="openPreview()"></button>
          </div>
        </div>

        <!-- Solution Panel -->
        <div *ngIf="activePanel()===1" class="space-y-4">
          <ng-container *ngIf="showSolutionWarning(); else solutionContent">
            <div class="solution-warning rounded border border-yellow-400 bg-yellow-100/10 p-4 flex gap-3">
              <div class="icon-warning"><i class="pi pi-exclamation-triangle"></i></div>
              <div class="content">
                <h3 class="font-semibold mb-2">Are you sure you want to see the solution?</h3>
                <p class="mb-3">You’re about to reveal the full answer and overwrite your editor with the solution code.
                </p>
                <div class="actions flex items-center gap-3">
                  <button pButton label="Show solution" class="p-button-danger"
                    (click)="confirmSolutionReveal()"></button>
                  <button pButton label="Cancel" class="p-button-text" (click)="cancelSolutionReveal()"></button>
                </div>
              </div>
            </div>
          </ng-container>

          <ng-template #solutionContent>
            <h2 class="text-base font-semibold">Solution Explanation</h2>
            <div class="whitespace-pre-wrap text-xs leading-5">
              {{ question()?.solution }}
            </div>
          </ng-template>
        </div>
      </div>
    </ng-container>
  </aside>

  <!-- VERTICAL SPLITTER -->
  <div *ngIf="!descCollapsed()" class="splitter" [class.dragging]="isDraggingVertical()"
    (pointerdown)="startHorizontalDrag($event)"></div>

  <!-- RIGHT COLUMN -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- JS banner -->
    <div *ngIf="tech!=='angular' && showRestoreBanner()"
      class="restore-banner px-3 py-1.5 bg-yellow-200 text-black text-xs relative text-center">
      <span class="font-medium">Your code was restored from client storage.</span>
      <div class="absolute right-2 inset-y-0 flex items-center gap-3">
        <button class="underline font-medium" (click)="resetFromBanner()">Reset to default</button>
        <button class="opacity-70 hover:opacity-100" (click)="dismissRestoreBanner()">✕</button>
      </div>
    </div>

    <!-- ANGULAR via StackBlitz SDK -->
    <ng-container *ngIf="tech==='angular'">
      <div
        class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex-1 flex flex-col overflow-hidden relative">
        <div *ngIf="showRestoreBanner()"
          class="absolute top-0 left-0 right-0 z-[60] bg-yellow-200 text-black text-sm px-3 py-2 shadow relative text-center">
          <span class="font-medium">Your code was restored from client storage.</span>
          <div class="absolute right-3 inset-y-0 flex items-center gap-3">
            <button class="underline font-medium" (click)="resetFromBanner()">Reset to default</button>
            <button class="opacity-70 hover:opacity-100" (click)="dismissRestoreBanner()">✕</button>
          </div>
        </div>

        <div class="relative flex-1">
          <div #sbHost class="w-full h-full"></div>
          <div *ngIf="embedLoading()" class="absolute inset-0 grid place-items-center bg-black/40">
            <p-progressSpinner strokeWidth="4"></p-progressSpinner>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- JAVASCRIPT / TYPESCRIPT EDITOR & TESTS -->
    <ng-container *ngIf="tech!=='angular'">
      <div class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex flex-col flex-1 overflow-hidden">
        <div class="flex items-center border-b border-white/10 px-4">
          <div class="flex">
            <button class="px-4 py-2" [class.opacity-100]="isTopCodeTab()" [class.opacity-60]="!isTopCodeTab()"
              (click)="topTab.set('code')">&lt;/&gt; Code</button>
            <button class="px-4 py-2" [class.opacity-100]="isTopTestsTab()" [class.opacity-60]="!isTopTestsTab()"
              (click)="topTab.set('tests')"><i class="pi pi-clipboard mr-2"></i> Test cases</button>
          </div>

          <div class="ml-auto flex items-center gap-2">
            <span class="text-xs opacity-70">Language</span>
            <select #langSel class="bg-neutral-800 border border-white/10 rounded px-2 py-1 text-sm" [value]="jsLang()"
              (change)="setLanguage($any(langSel).value)" aria-label="Editor language">
              <option value="js">JavaScript</option>
              <option value="ts">TypeScript</option>
            </select>
          </div>
        </div>

        <div #splitContainer class="flex-1 flex flex-col overflow-hidden">
          <div class="overflow-hidden" [style.flex]="'0 0 ' + (editorRatio()*100) + '%'" style="min-height:120px;">
            <app-monaco-editor *ngIf="isTopCodeTab()" class="h-full" [code]="editorContent()"
              [language]="jsLang()==='ts' ? 'typescript' : 'javascript'" [options]="editorMonacoOptions"
              (codeChange)="onJsCodeChange($event)"></app-monaco-editor>

            <app-monaco-editor *ngIf="isTopTestsTab()" class="h-full" [code]="testCode()" [language]="'javascript'"
              [options]="editorMonacoOptions" (codeChange)="testCode.set($event)"></app-monaco-editor>
          </div>

          <div class="horizontal-splitter" [class.dragging]="isDraggingHorizontal()" (pointerdown)="startDrag($event)">
          </div>

          <div class="flex-1 flex flex-col overflow-hidden min-h-0">
            <div class="flex items-center gap-6 px-3 py-2 text-xs border-b border-white/10 bg-neutral-900/60">
              <button class="font-medium" (click)="runTests()">▶ Run tests</button>
              <button [class.text-white]="isTestsTab()" [class.text-gray-300]="!isTestsTab()"
                (click)="subTab.set('tests')">Results</button>
              <button [class.text-white]="isConsoleTab()" [class.text-gray-300]="!isConsoleTab()"
                (click)="subTab.set('console')">Console</button>
              <span class="ml-auto opacity-80" *ngIf="hasRunTests">{{ passedCount() }}/{{ totalCount() }} passed</span>
            </div>

            <div class="flex-1 min-h-0 overflow-hidden">
              <!-- Results -->
              <div *ngIf="isTestsTab()" class="h-full overflow-auto p-4 results-panel">
                <div *ngIf="!hasRunTests" class="h-full grid place-items-center">
                  <div class="text-center">
                    <div class="icon-hero mb-3"><i class="pi pi-play"></i></div>
                    <h3 class="text-base font-semibold mb-2">Test your code</h3>
                    <p class="text-gray-400 mb-4 text-xs">
                      Run your code with
                      <a href="" class="text-yellow-300 underline" (click)="goToCustomTests($event)">custom test
                        cases</a>
                      before submitting.
                    </p>
                    <button pButton label="Run" icon="pi pi-play" (click)="runTests()"></button>
                  </div>
                </div>

                <div *ngIf="hasRunTests" class="space-y-2">
                  <div class="summary mb-2">
                    <strong>{{ passedCount() }}</strong>/<strong>{{ totalCount() }}</strong> passed
                    <ng-container *ngIf="totalCount() > 0">
                      <span *ngIf="allPassing()" class="text-green-500 ml-2">All tests passed ✓</span>
                      <span *ngIf="!allPassing()" class="text-red-400 ml-2">Some tests failed</span>
                    </ng-container>
                    <ng-container *ngIf="totalCount() === 0">
                      <span class="text-yellow-400 ml-2">No tests reported</span>
                    </ng-container>
                  </div>

                  <div *ngFor="let t of testResults()" class="test-card border rounded-md"
                    [ngClass]="t.passed ? 'border-green-500 bg-green-100/10' : 'border-red-500 bg-red-100/10'">
                    <div class="test-name">
                      <i
                        [ngClass]="t.passed ? 'pi pi-check-circle text-green-400' : 'pi pi-times-circle text-red-400'"></i>
                      <span>{{ t.name }}</span>
                    </div>
                    <div *ngIf="t.error" class="test-error text-red-300 whitespace-pre-wrap break-words">
                      {{ t.error }}
                    </div>
                  </div>
                </div>
              </div>

              <!-- Console -->
              <div [style.display]="isConsoleTab() ? 'flex' : 'none'" class="flex-1 min-h-0 flex flex-col">
                <app-console-logger class="flex-1" [entries]="consoleEntries()" [results]="testResults()" [max]="500"
                  [autoScroll]="true">
                </app-console-logger>

              </div>
            </div>
          </div>
        </div>
      </div>
    </ng-container>
  </main>
</div>

<!-- Footer -->
<app-footer [mode]="isCourseContext() ? 'course' : 'practice'" [progressText]="!isCourseContext() ? progressText : null"
  [prevDisabled]="!hasPrev()" [nextDisabled]="!hasNext()" [nextDisabledTooltip]="null"
  [breadcrumbLabel]="courseCrumbLabel" [coursePrevLabel]="coursePrevLabel" [courseNextLabel]="courseNextLabel"
  [middleSuffixLabel]="kind === 'debug' ? 'Debugging challenge' : 'Coding task'" [leftCourseLabel]="leftDrawerLabel"
  [outline]="courseOutline || []" [currentLessonId]="currentCourseLessonId" [showSubmit]="!isCourseContext()"
  [submitLabel]="tech !== 'angular' ? 'Submit' : 'Mark as complete'" (prev)="prev()" (next)="next()"
  (back)="backToReturn()" (coursePrev)="goCoursePrev()" (courseNext)="goCourseNext()"
  (selectLesson)="onSelectFromFooter($event)" (submit)="submitCode()">
</app-footer>

<!-- Preview dialog -->
<p-dialog [(visible)]="previewVisible" [modal]="true" [dismissableMask]="true" [closable]="false" [draggable]="false"
  [resizable]="false" [style]="{ width: '90vw', maxWidth: '1400px' }" [contentStyle]="{ padding: '0', height: '80vh' }">
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full">
      <div class="font-semibold">Preview</div>
      <button pButton icon="pi pi-times" class="p-button-text" (click)="closePreview()"></button>
    </div>
  </ng-template>
  <div class="w-full h-full">
    <iframe *ngIf="previewOnlyUrl" class="w-full h-full border-0" [src]="previewOnlyUrl"
      [attr.sandbox]="'allow-scripts allow-popups allow-modals'" [attr.allow]="''"
      referrerpolicy="no-referrer"></iframe>
  </div>
</p-dialog>