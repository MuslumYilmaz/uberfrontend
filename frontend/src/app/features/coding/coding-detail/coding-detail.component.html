<div class="coding-detail fixed-under-header flex gap-[5px]">
  <!-- LEFT COLUMN -->
  <aside class="flex flex-col bg-neutral-900/95 rounded-lg shadow-sm border border-white/10 overflow-hidden"
    [style.flex]="asideFlex()" style="min-width:0;">
    <!-- Collapsed rail -->
    <div *ngIf="descCollapsed()" class="h-full w-full flex flex-col items-center justify-between py-2">
      <div class="flex flex-col items-center gap-2">
        <button pButton type="button" icon="pi pi-chevron-right" class="p-button-rounded p-button-text"
          (click)="toggleDescription()" aria-label="Expand description"></button>

        <button pButton type="button" icon="pi pi-file" class="p-button-rounded p-button-text"
          [ngClass]="{ 'text-white': activePanel()===0, 'opacity-60': activePanel()!==0 }"
          (click)="activePanel.set(0); toggleDescription()" aria-label="Description"></button>

        <button pButton type="button" icon="pi pi-code" class="p-button-rounded p-button-text"
          [ngClass]="{ 'text-white': activePanel()===1, 'opacity-60': activePanel()!==1 }"
          (click)="onSolutionTabClick()" aria-label="Solution"></button>
      </div>
      <div></div>
    </div>

    <!-- Expanded content -->
    <ng-container *ngIf="!descCollapsed()">
      <div class="flex items-center border-b border-white/10 text-white">
        <div class="flex-1 flex">
          <button class="px-4 py-2 flex-1 text-left font-medium" [class.border-b-2]="activePanel()===0"
            [class.text-blue-400]="activePanel()===0" [class.text-gray-300]="activePanel()!==0"
            (click)="activePanel.set(0)">Description</button>

          <button class="px-4 py-2 flex-1 text-left font-medium" [class.border-b-2]="activePanel()===1"
            [class.text-blue-400]="activePanel()===1" [class.text-gray-300]="activePanel()!==1"
            (click)="onSolutionTabClick()">Solution</button>
        </div>

        <button class="px-3 py-2 text-gray-300 hover:text-white p-button-text" pButton type="button"
          icon="pi pi-chevron-left" (click)="toggleDescription()" aria-label="Hide description"></button>
      </div>

      <div class="flex-1 overflow-auto p-6 font-sm">
        <!-- Description Panel -->
        <ng-container *ngIf="activePanel()===0">
          <section class="space-y-4">
            <h1 class="text-xl font-bold">{{ question()?.title }}</h1>
            <div class="text-xs text-gray-400 capitalize">{{ question()?.difficulty }}</div>

            <!-- Özet / prose -->
            <div *ngIf="(descSummary() || descriptionText()) as prose" class="whitespace-pre-wrap opacity-90 mt-3">
              {{ prose }}
            </div>

            <!-- Argümanlar -->
            <div *ngIf="descArgs().length" class="mt-4">
              <h3 class="text-sm font-semibold mb-1">Arguments</h3>
              <ul class="font-sm space-y-1">
                <li *ngFor="let a of descArgs()">
                  <code class="opacity-80">{{a.name}}</code>
                  <span *ngIf="a.type" class="opacity-60">: {{a.type}}</span>
                  <span *ngIf="a.desc"> — {{a.desc}}</span>
                </li>
              </ul>
            </div>

            <!-- Dönüş değeri -->
            <div *ngIf="descReturns()" class="mt-3 text-sm">
              <h3 class="text-sm font-semibold mb-1">Returns</h3>
              <div>
                <span *ngIf="descReturns()?.type"><code class="opacity-80">{{descReturns()?.type}}</code> — </span>
                <span class="font-sm">{{descReturns()?.desc}}</span>
              </div>
            </div>

            <!-- Örnekler -->
            <ng-container *ngIf="!isFrameworkTech() && !isWebTech() && combinedExamples()">
              <div class="mt-6">
                <div class="flex items-center justify-between mb-2">
                  <span class="text-xs uppercase font-semibold">Examples</span>
                </div>

                <div class="code-wrap">
                  <app-monaco-editor class="rounded border border-white/10 pointer-events-none select-none w-full block"
                    [code]="combinedExamples()" [language]="tech==='angular' ? 'typescript' : 'javascript'"
                    [readOnly]="true" [options]="examplesMonacoOptions" [autoHeight]="true" [maxHeight]="560"
                    [interactive]="false">
                  </app-monaco-editor>

                  <button class="copy-fab" aria-label="Copy examples" title="Copy" (click)="copyExamples()">
                    <i class="pi" [ngClass]="copiedExamples() ? 'pi-check' : 'pi-copy'"></i>
                  </button>
                </div>
              </div>
            </ng-container>

            <!-- Frameworks + Web: show Solution CTA instead of Examples -->
            <ng-container *ngIf="isFrameworkTech() || isWebTech()">
              <div class="mt-6 flex items-center gap-3">
                <button class="text-xs px-3 py-2 rounded border border-white/20 hover:bg-white/5"
                  (click)="onSolutionTabClick()">
                  View solution (read-only)
                </button>

                <!-- Only for JS/TS load; hidden on frameworks+web -->
                <!-- (kept here for completeness but will not render because of *ngIf above) -->
                <button *ngIf="false" class="text-xs px-3 py-2 rounded border border-white/20 hover:bg-white/5"
                  (click)="loadSolutionIntoEditor()">
                  Load solution into editor
                </button>

                <!-- Web (HTML/CSS): allow previewing the official solution -->
                <button *ngIf="isWebTech()" class="text-xs px-3 py-2 rounded border border-white/20 hover:bg-white/5"
                  (click)="openSolutionPreview()">
                  Preview solution
                </button>
              </div>
            </ng-container>

            <!-- Similar questions -->
            <section *ngIf="followUpItems().length" class="mt-6">
              <div
                class="flex items-center justify-between px-3 py-2 border border-white/15 rounded cursor-pointer select-none"
                (click)="similarOpen.set(!similarOpen())">
                <h3 class="text-sm font-semibold">Similar questions</h3>
                <i class="pi" [ngClass]="similarOpen() ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
              </div>

              <div *ngIf="similarOpen()" class="mt-1 rounded border border-white/10 overflow-hidden">
                <a *ngFor="let f of followUpItems()" [routerLink]="f.to"
                  class="flex items-center justify-between px-4 py-3 border-b border-white/5 hover:bg-white/5">
                  <span class="truncate">{{ f.title }}</span>
                  <span class="text-yellow-300 text-sm ml-4 capitalize">{{ f.difficulty || '—' }}</span>
                </a>
              </div>
            </section>

            <!-- Framework önizleme düğmesi -->
            <div>
              <button *ngIf="isFrameworkTech()" pButton label="Preview what you need to build" icon="pi pi-eye"
                class="mt-6" (click)="openPreview()"></button>
            </div>
          </section>
        </ng-container>


        <!-- Solution Panel -->
        <ng-container *ngIf="activePanel()===1">
          <section class="space-y-4">
            <!-- Uyarı -->
            <ng-container *ngIf="showSolutionWarning(); else solBody">
              <div class="solution-warning">
                <div class="flex items-start gap-3">
                  <div class="icon-warning"><i class="pi pi-exclamation-triangle"></i></div>
                  <div class="flex-1">
                    <div class="font-medium mb-1">Are you sure you want to view the solution?</div>
                    <div class="text-sm opacity-80 mb-3">
                      Viewing the solution early can reduce learning benefits. You can still load it read-only.
                    </div>
                    <div class="actions flex items-center gap-3">
                      <button pButton label="View solution" class="p-button-danger"
                        (click)="confirmSolutionReveal()"></button>
                      <button pButton label="Cancel" class="p-button-text" (click)="cancelSolutionReveal()"></button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>

            <!-- İçerik -->
            <ng-template #solBody>
              <h2 class="text-base font-semibold mb-2">Solution</h2>

              <!-- Overview -->
              <section class="space-y-2 mb-5" *ngIf="structuredSolution()?.overview">
                <h3 class="text-sm font-semibold opacity-90">Overview</h3>
                <div class="solution-prose prose prose-invert max-w-none"
                  [innerHTML]="md(structuredSolution()?.overview)"></div>
              </section>

              <!-- Approaches -->
              <div class="p-3" *ngFor="let ap of approaches(); let i = index">
                <div class="ap-row">
                  <span class="ap-num">{{ i + 1 }}</span>
                  <h4 class="ap-title">{{ ap.title }}</h4>
                  <div class="ap-actions">
                    <button class="uf-btn" (click)="loadApproach(ap)" title="Load into editor">
                      Load into editor
                    </button>
                  </div>
                </div>

                <!-- prose stays the same -->
                <div *ngIf="ap.prose" class="solution-prose prose prose-invert max-w-none mb-3"
                  [innerHTML]="md(ap.prose)"></div>

                <!-- WEB: show HTML and CSS as separate, nicely labeled blocks -->
                <ng-container *ngIf="isWebTech(); else nonWebApproach">
                  <div class="code-wrap mb-2" *ngIf="ap.codeHtml">
                    <div class="px-2 py-1 text-xs opacity-80">&lt;html&gt;</div>
                    <app-monaco-editor
                      class="rounded border border-white/10 pointer-events-none select-none w-full block"
                      [code]="prettifyHtml(unescapeJsLiterals(ap.codeHtml || ''))" [language]="'html'" [readOnly]="true"
                      [autoHeight]="true" [options]="examplesMonacoOptions">
                    </app-monaco-editor>
                    <button class="copy-fab" aria-label="Copy HTML" title="Copy HTML"
                      (click)="onCopyApproach(i, prettifyHtml(unescapeJsLiterals(ap.codeHtml || '')))">
                      <i class="pi" [ngClass]="copiedIdx===i ? 'pi-check' : 'pi-copy'"></i>
                    </button>
                  </div>

                  <div class="code-wrap" *ngIf="ap.codeCss">
                    <div class="px-2 py-1 text-xs opacity-80"># CSS</div>
                    <app-monaco-editor
                      class="rounded border border-white/10 pointer-events-none select-none w-full block"
                      [code]="prettifyCss(unescapeJsLiterals(ap.codeCss || ''))" [language]="'css'" [readOnly]="true"
                      [autoHeight]="true" [options]="examplesMonacoOptions">
                    </app-monaco-editor>
                    <button class="copy-fab" aria-label="Copy CSS" title="Copy CSS"
                      (click)="onCopyApproach(i, prettifyCss(unescapeJsLiterals(ap.codeCss || '')))">
                      <i class="pi" [ngClass]="copiedIdx===i ? 'pi-check' : 'pi-copy'"></i>
                    </button>
                  </div>
                </ng-container>

                <!-- JS/TS path (unchanged) -->
                <ng-template #nonWebApproach>
                  <div class="code-wrap">
                    <app-monaco-editor
                      class="rounded border border-white/10 pointer-events-none select-none w-full block"
                      [code]="codeFor(ap)" [language]="currentJsLang()==='ts' ? 'typescript' : 'javascript'"
                      [readOnly]="true" [autoHeight]="true" [options]="examplesMonacoOptions">
                    </app-monaco-editor>
                    <button class="copy-fab" aria-label="Copy code" title="Copy"
                      (click)="onCopyApproach(i, codeFor(ap))">
                      <i class="pi" [ngClass]="copiedIdx===i ? 'pi-check' : 'pi-copy'"></i>
                    </button>
                  </div>
                </ng-template>
              </div>

              <!-- Notes / Pitfalls / Edge cases / Techniques -->
              <section class="space-y-3 mb-6" *ngIf="hasAnyNotes()">
                <h3 class="text-sm font-semibold opacity-90">Notes &amp; Pitfalls</h3>

                <div class="grid md:grid-cols-3 gap-3">
                  <div *ngIf="structuredSolution()?.notes?.pitfalls?.length" class="p-3 rounded border border-white/10">
                    <div class="text-xs uppercase opacity-70 mb-2">Pitfalls</div>
                    <ul class="list-disc list-inside text-sm space-y-1">
                      <li class="font-sm" *ngFor="let p of structuredSolution()?.notes?.pitfalls">{{ p }}</li>
                    </ul>
                  </div>

                  <div *ngIf="structuredSolution()?.notes?.edgeCases?.length"
                    class="p-3 rounded border border-white/10">
                    <div class="text-xs uppercase opacity-70 mb-2">Edge cases</div>
                    <ul class="list-disc list-inside text-sm space-y-1">
                      <li class="font-sm" *ngFor="let e of structuredSolution()?.notes?.edgeCases">{{ e }}</li>
                    </ul>
                  </div>

                  <div *ngIf="structuredSolution()?.notes?.techniques?.length"
                    class="p-3 rounded border border-white/10">
                    <div class="text-xs uppercase opacity-70 mb-2">Techniques</div>
                    <ul class="list-disc list-inside text-sm space-y-1">
                      <li class="font-sm" *ngFor="let t of structuredSolution()?.notes?.techniques">{{ t }}</li>
                    </ul>
                  </div>
                </div>
              </section>

              <!-- Follow-up -->
              <!-- Similar questions -->
              <section *ngIf="followUpItems().length" class="mt-6">
                <div
                  class="flex items-center justify-between px-3 py-2 border border-white/15 rounded cursor-pointer select-none"
                  (click)="similarOpen.set(!similarOpen())">
                  <h3 class="text-sm font-semibold">Similar questions</h3>
                  <i class="pi" [ngClass]="similarOpen() ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
                </div>

                <div *ngIf="similarOpen()" class="mt-1 rounded border border-white/10 overflow-hidden">
                  <a *ngFor="let f of followUpItems()" [routerLink]="f.to"
                    class="flex items-center justify-between px-4 py-3 border-b border-white/5 hover:bg-white/5">
                    <span class="truncate">{{ f.title }}</span>
                    <span class="text-yellow-300 text-sm ml-4 capitalize">{{ f.difficulty || '—' }}</span>
                  </a>
                </div>
              </section>

              <!-- Resources -->
              <section class="space-y-2" *ngIf="structuredSolution()?.resources?.length">
                <h3 class="text-sm font-semibold opacity-90">Resources</h3>
                <ul class="text-sm space-y-1">
                  <li class="font-sm" *ngFor="let r of structuredSolution()?.resources">
                    <a class="underline text-yellow-300" [href]="r.url" target="_blank" rel="noopener noreferrer">
                      {{ r.title }}
                    </a>
                  </li>
                </ul>
              </section>

            </ng-template>
          </section>
        </ng-container>

      </div>
    </ng-container>
  </aside>

  <!-- VERTICAL SPLITTER -->
  <div *ngIf="!descCollapsed()" class="splitter" [class.dragging]="isDraggingHorizontal()"
    (pointerdown)="startHorizontalDrag($event)"></div>

  <!-- RIGHT COLUMN -->
  <main class="flex-1 flex flex-col overflow-hidden">
    <!-- Restore banner (frameworks + web) -->
    <div *ngIf="(isFrameworkTech() || isWebTech()) && showRestoreBanner()"
      class="restore-banner px-3 py-1.5 bg-yellow-200 text-black text-xs relative text-center">
      <span class="font-medium">Your code was restored from client storage.</span>
      <div class="absolute right-2 inset-y-0 flex items-center gap-3">
        <button class="underline font-medium" (click)="resetFromBanner()">Reset to default</button>
        <button class="opacity-70 hover:opacity-100" (click)="dismissRestoreBanner()">✕</button>
      </div>
    </div>


    <!-- FRAMEWORK: Angular / React (our editor + our preview, no StackBlitz) -->
    <ng-container *ngIf="isFrameworkTech()">
      <div
        class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex-1 flex flex-col overflow-hidden relative">
        <!-- File Drawer -->
        <div class="file-drawer" [class.open]="showFileDrawer()">
          <div class="backdrop" (click)="closeFiles()"></div>

          <div class="panel">
            <div class="panel-header">
              <div>Files</div>
              <button class="icon-btn" title="Close" (click)="closeFiles()">
                <i class="pi pi-times"></i>
              </button>
            </div>

            <div class="panel-body">
              <!-- File Tree -->
              <div class="panel-body">
                <ul class="file-tree">
                  <ng-template #renderNodes let-nodes let-depth="depth">
                    <li *ngFor="let n of nodes">
                      <!-- Folder row -->
                      <div *ngIf="n.type === 'dir'" class="tree-row folder-row" [style.paddingLeft.px]="depth * 12 + 8"
                        (click)="toggleDir(n.path)" [class.open]="isOpen(n.path)">
                        <i class="pi pi-chevron-right caret" aria-hidden="true"></i>
                        <i class="pi pi-folder folder-ico" aria-hidden="true"></i>
                        <span class="name" [title]="n.path">{{ n.name }}</span>
                      </div>

                      <!-- Children -->
                      <ul *ngIf="isOpen(n.path)" class="children">
                        <ng-container
                          *ngTemplateOutlet="renderNodes; context: { $implicit: n.children, depth: depth + 1 }"></ng-container>
                      </ul>

                      <!-- File row -->
                      <div *ngIf="n.type === 'file'" class="tree-row file-row"
                        [class.active]="(openPath()||frameworkEntryFile)===n.path"
                        [style.paddingLeft.px]="depth * 12 + 28" (click)="openFile(n.path); closeFiles()"
                        [title]="n.path">
                        <i class="pi pi-file file-ico" aria-hidden="true"></i>
                        <span class="name">{{ n.name }}</span>
                      </div>
                    </li>
                  </ng-template>

                  <ng-container
                    *ngTemplateOutlet="renderNodes; context: { $implicit: treeRoots(), depth: 0 }"></ng-container>
                </ul>
              </div>

            </div>
          </div>
        </div>

        <div class="flex-1 grid grid-cols-2 gap-px min-h-0">
          <!-- LEFT: header + Monaco editor -->
          <div class="min-w-0 min-h-0 flex flex-col">
            <div class="flex items-center justify-between border-b border-white/10 px-2 py-1">
              <!-- LEFT: hamburger + path -->
              <div class="flex items-center gap-2 min-w-0">
                <button class="icon-btn" [class.active]="showFileDrawer()" (click)="toggleFiles()"
                  aria-label="Toggle files" title="Files">
                  <i class="pi pi-bars"></i>
                </button>
                <div class="text-xs opacity-80 truncate" [title]="currentPath()">
                  {{ currentFileLabel() }}
                </div>
              </div>

              <!-- RIGHT: actions -->
              <div class="flex items-center gap-2">
                <button class="text-xs px-2 py-1 border border-white/10 rounded" (click)="rebuildFrameworkPreview()">
                  Rebuild preview
                </button>
              </div>
            </div>

            <section class="min-w-0 min-h-0 flex-1 flex">
              <ng-container *ngIf="showEditor()">
                <app-monaco-editor class="flex-1 min-h-0 h-full editor-fill" [code]="editorContent()"
                  [language]="langFromPath(openPath() || frameworkEntryFile)" [options]="editorMonacoOptions"
                  (codeChange)="onFrameworkCodeChange($event)">
                </app-monaco-editor>
              </ng-container>
            </section>
          </div>

          <!-- RIGHT: your own preview iframe -->
          <div class="relative min-w-0 min-h-0">
            <div *ngIf="!previewUrl()" class="absolute inset-0 grid place-items-center text-xs text-gray-400">
              No preview yet. Click “Rebuild preview”.
            </div>
            <iframe *ngIf="previewUrl()" class="absolute inset-0 w-full h-full border-0 bg-white" [src]="previewUrl()"
              referrerpolicy="no-referrer"
              sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation">
            </iframe>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- NON-FRAMEWORK: WEB or JS -->
    <ng-container *ngIf="!isFrameworkTech()">
      <!-- WEB: HTML + CSS + PREVIEW/TEST-CODE tabs + Results/Console -->
      <ng-container *ngIf="isWebTech(); else jsBlock">
        <div class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex flex-col flex-1 overflow-hidden">
          <div class="flex-1 min-h-0 flex">
            <!-- LEFT editors -->
            <div class="min-w-0 flex flex-col" [style.flex]="'0 0 ' + (webColsRatio()*100) + '%'">
              <div #splitContainer class="flex-1 min-h-0 flex flex-col">
                <div class="border-b border-white/10 px-3 py-1 text-xs opacity-80">&lt;html&gt; HTML</div>

                <div class="overflow-hidden" [style.flex]="'0 0 ' + (editorRatio()*100) + '%'"
                  style="min-height:120px;">
                  <app-monaco-editor class="h-full editor-fill" [code]="webHtml()" [language]="'html'"
                    [options]="editorMonacoOptions" (codeChange)="onHtmlChange($event)">
                  </app-monaco-editor>
                </div>

                <div class="horizontal-splitter" [class.dragging]="isDraggingHorizontal()"
                  (pointerdown)="startDrag($event)"></div>

                <div class="flex-1 min-h-0 flex flex-col">
                  <div class="border-b border-white/10 px-3 py-1 text-xs opacity-80"># CSS</div>
                  <app-monaco-editor class="flex-1 editor-fill" [code]="webCss()" [language]="'css'"
                    [options]="editorMonacoOptions" (codeChange)="onCssChange($event)">
                  </app-monaco-editor>
                </div>
              </div>
            </div>

            <!-- MIDDLE splitter -->
            <div class="splitter" [class.dragging]="isDraggingCols()" (pointerdown)="startWebColumnDrag($event)"></div>

            <!-- RIGHT: top (Preview/Test code) + bottom (Results/Console) -->
            <div class="min-w-0 flex-1 flex flex-col">
              <div #previewSplit class="flex-1 flex flex-col overflow-hidden">
                <!-- TOP TABS -->
                <div class="flex items-center border-b border-white/10 px-3 py-2 text-xs">
                  <button class="px-3 py-1" [class.opacity-100]="isPreviewTop()" [class.opacity-60]="!isPreviewTop()"
                    (click)="previewTopTab.set('preview')">Preview</button>
                  <button class="px-3 py-1" [class.opacity-100]="isTestCodeTop()" [class.opacity-60]="!isTestCodeTop()"
                    (click)="previewTopTab.set('testcode')">Test code</button>
                  <div class="ml-auto text-xs opacity-70">Live preview updates as you type</div>
                </div>

                <!-- TOP CONTENT -->
                <div [style.flex]="'0 0 ' + (previewRatio()*100) + '%'" class="relative min-h-[160px]">
                  <div *ngIf="!previewUrl()" class="absolute inset-0 grid place-items-center text-xs text-gray-400"
                    [style.display]="isPreviewTop() ? 'grid' : 'none'">
                    Building preview…
                  </div>

                  <!-- WEB PREVIEW TOGGLE -->
                  <div *ngIf="isWebTech()" class="absolute top-2 right-3 z-20 flex items-center gap-2">
                    <!-- Show Preview button (when not showing solution) -->
                    <button *ngIf="!showingSolutionPreview"
                      class="text-xs px-3 py-1.5 rounded bg-blue-600 text-white hover:bg-blue-500"
                      (click)="openSolutionPreview()">
                      Show preview
                    </button>

                    <!-- Close banner (when showing solution) -->
                    <div *ngIf="showingSolutionPreview"
                      class="bg-yellow-300 text-black text-xs px-3 py-1.5 rounded shadow-sm flex items-center gap-3">
                      <span class="font-medium">Showing solution preview</span>
                      <button class="text-xs underline" (click)="closeSolutionPreview()">Close preview</button>
                    </div>
                  </div>

                  <!-- Existing iframe -->
                  <iframe #previewFrame class="absolute inset-0 w-full h-full border-0 bg-white"
                    [style.display]="isPreviewTop() ? 'block' : 'none'"
                    sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-modals allow-top-navigation-by-user-activation"
                    [src]="previewUrl()" referrerpolicy="no-referrer">
                  </iframe>

                  <div class="absolute inset-0" [style.display]="isTestCodeTop() ? 'block' : 'none'">
                    <app-monaco-editor class="h-full" [code]="testCode()" [language]="'javascript'"
                      [options]="editorMonacoOptions" (codeChange)="testCode.set($event)">
                    </app-monaco-editor>
                  </div>
                </div>

                <!-- Splitter between TOP and BOTTOM -->
                <div class="horizontal-splitter" [class.dragging]="isDraggingRight()"
                  (pointerdown)="startPreviewDrag($event)"></div>

                <!-- BOTTOM: Results / Console -->
                <div class="flex-1 min-h-[140px] flex flex-col border-t border-white/10">
                  <div class="flex items-center gap-6 px-3 py-2 text-xs bg-neutral-900/60">
                    <button class="font-medium" (click)="runWebTests()" [disabled]="!hasAnyTests()"
                      [title]="hasAnyTests() ? 'Run tests' : 'Add tests to enable'">▶ Run tests</button>
                    <button [class.text-white]="isTestsTab()" [class.text-gray-300]="!isTestsTab()"
                      (click)="subTab.set('tests')">Results</button>
                    <button [class.text-white]="isConsoleTab()" [class.text-gray-300]="!isConsoleTab()"
                      (click)="subTab.set('console')">Console</button>
                    <span class="ml-auto opacity-80" *ngIf="hasRunTests && totalCount() > 0">
                      {{ passedCount() }}/{{ totalCount() }} passed
                    </span>
                  </div>

                  <div class="flex-1 min-h-0 overflow-hidden">
                    <!-- Results -->
                    <div *ngIf="isTestsTab()" class="h-full overflow-auto p-4 results-panel">
                      <!-- 1) No tests at all -->
                      <div class="h-full grid place-items-center text-xs text-gray-400" *ngIf="!hasAnyTests()">
                        No tests provided for this challenge yet.
                      </div>

                      <!-- 2) Tests exist but not run yet -->
                      <div class="h-full grid place-items-center text-xs text-gray-400"
                        *ngIf="hasAnyTests() && !hasRunTests">
                        Run tests to see results.
                      </div>

                      <!-- 3) Tests run: show summary + list -->
                      <div *ngIf="hasAnyTests() && hasRunTests" class="space-y-2">
                        <div class="summary mb-2">
                          <strong>{{ passedCount() }}</strong>/<strong>{{ totalCount() }}</strong> passed
                          <span *ngIf="allPassing()" class="text-green-500 ml-2">All tests passed ✓</span>
                          <span *ngIf="!allPassing()" class="text-red-400 ml-2">Some tests failed</span>
                        </div>

                        <div *ngFor="let t of testResults()" class="test-card border rounded-md"
                          [ngClass]="t.passed ? 'border-green-500 bg-green-100/10' : 'border-red-500 bg-red-100/10'">
                          <div class="test-name">
                            <i [ngClass]="t.passed ? 'pi pi-check-circle text-green-400'
               : 'pi pi-times-circle text-red-400'"></i>
                            <span>{{ t.name }}</span>
                          </div>
                          <div *ngIf="t.error" class="test-error text-red-300 whitespace-pre-wrap break-words">
                            {{ t.error }}
                          </div>
                        </div>
                      </div>
                    </div>


                    <!-- Console -->
                    <div [style.display]="isConsoleTab() ? 'flex' : 'none'" class="flex-1 min-h-0 flex flex-col">
                      <app-console-logger class="flex-1" [entries]="consoleEntries()" [results]="testResults()"
                        [max]="500" [autoScroll]="true">
                      </app-console-logger>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-container>

      <!-- JS / TS EDITOR & TESTS -->
      <ng-template #jsBlock>
        <app-coding-js-panel #jsPanel class="flex-1 min-h-0 flex" [question]="question()!" [tech]="tech" [kind]="kind"
          [editorOptions]="editorMonacoOptions" (langChange)="onChildLang($event)"
          (solvedChange)="solved.set($event); saveSolvedFlag(question()!, $event)"
          (testResultsChange)="testResults.set($event)" (consoleEntriesChange)="consoleEntries.set($event)"
          (codeChange)="onChildCode($event)">
        </app-coding-js-panel>
      </ng-template>
    </ng-container>
  </main>
</div>

<!-- Footer -->
<app-footer [mode]="isCourseContext() ? 'course' : 'practice'" [progressText]="!isCourseContext() ? progressText : null"
  [prevDisabled]="!hasPrev()" [nextDisabled]="!hasNext()" [nextDisabledTooltip]="null"
  [middleSuffixLabel]="kind === 'debug' ? 'Debugging challenge' : 'Coding task'" [leftCourseLabel]="leftDrawerLabel"
  [outline]="courseOutline || []" [currentLessonId]="currentCourseLessonId" [showSubmit]="!isCourseContext()"
  [submitLabel]="(isFrameworkTech() || isWebTech()) ? 'Mark as complete' : 'Submit'" (prev)="prev()" (next)="next()"
  (back)="backToReturn()" (coursePrev)="goCoursePrev()" (courseNext)="goCourseNext()"
  (selectLesson)="onSelectFromFooter($event)" (submit)="submitCode()">
</app-footer>

<!-- Preview dialog (Angular only) -->
<p-dialog [(visible)]="previewVisible" [modal]="true" [dismissableMask]="true" [closable]="false" [draggable]="false"
  [resizable]="false" [style]="{ width: '90vw', maxWidth: '1400px' }" [contentStyle]="{ padding: '0', height: '80vh' }">
  <ng-template pTemplate="header">
    <div class="flex items-center justify-between w-full">
      <div class="font-semibold">Preview</div>
      <button pButton icon="pi pi-times" class="p-button-text" (click)="closePreview()"></button>
    </div>
  </ng-template>
  <div class="w-full h-full">
    <iframe *ngIf="previewOnlyUrl" [src]="previewOnlyUrl" sandbox="allow-scripts allow-popups allow-modals"
      class="w-full h-full border-0" referrerpolicy="no-referrer"></iframe>
  </div>
</p-dialog>