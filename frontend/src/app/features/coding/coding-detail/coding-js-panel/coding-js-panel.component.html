<div class="bg-neutral-900 rounded-lg shadow-sm border border-white/10 flex flex-col flex-1 overflow-hidden" data-testid="js-panel">
    <!-- Header -->
    <div class="flex items-center border-b border-white/10 px-4">
        <div class="flex">
            <button class="px-4 py-2" [class.opacity-100]="topTab()==='code'" [class.opacity-60]="topTab()!=='code'"
                (click)="topTab.set('code')">&lt;/&gt; Code</button>
            <button class="px-4 py-2" [class.opacity-100]="topTab()==='tests'" [class.opacity-60]="topTab()!=='tests'"
                (click)="topTab.set('tests')"><i class="pi pi-clipboard mr-2"></i> Test cases</button>
        </div>

        <div class="ml-auto flex items-center gap-2">
            <span *ngIf="isViewingOlderVersion()" class="text-[11px] px-2 py-1 rounded bg-blue-500/20 text-blue-200 border border-blue-500/30"
                data-testid="older-draft-label">
                Older version
            </span>
            <span class="text-xs opacity-70">Language</span>
            <div class="lang-wrap">
                <select #langSel class="lang-select" data-testid="js-language-select" [value]="jsLang()" (change)="setLanguage(langSel.value)"
                    aria-label="Editor language">
                    <option value="js">JavaScript</option>
                    <option value="ts">TypeScript</option>
                </select>
                <span class="select-caret" aria-hidden="true"></span>
            </div>
        </div>
    </div>

    <!-- Restore banner -->
    <app-restore-banner *ngIf="!hideRestoreBanner" [isVisible]="restoredFromStorage() && !restoreDismissed()" [isSolution]="viewingSolution()"
        (reset)="resetToDefault()" (dismiss)="dismissRestoreBanner()">
    </app-restore-banner>

    <!-- Draft update banner (versioned drafts) -->
    <app-draft-update-banner *ngIf="showUpdateBanner() && !isViewingOlderVersion()"
        [isVisible]="true" mode="updated" [otherDrafts]="availableOlderDrafts()"
        (openVersion)="openOlderDraft($event)" (copyVersion)="copyDraftIntoLatest($event)" (dismiss)="dismissDraftUpdateBanner()">
    </app-draft-update-banner>

    <app-draft-update-banner *ngIf="isViewingOlderVersion()"
        [isVisible]="true" mode="older"
        (switchToCurrent)="backToLatestDraft()" (copyVersion)="copyActiveDraftIntoLatest()">
    </app-draft-update-banner>

    <!-- Editors -->
    <div class="flex-1 flex flex-col overflow-hidden">

        <!-- TOP: code/tests editor area with adjustable height -->
        <div class="relative min-h-0" [style.flex]="'0 0 ' + (editorRatio()*100) + '%'">
            <!-- CODE editor -->
            <div class="absolute inset-0" [style.display]="topTab()==='code' ? 'block' : 'none'">
                <ng-container *ngIf="useMonaco(); else liteCodeEditor">
                    <app-monaco-editor #codeEditor class="h-full editor-fill" data-testid="js-code-editor" [modelKey]="'q-' + question?.id + '-code'"
                        [code]="editorContent()" [language]="jsLang()==='ts' ? 'typescript':'javascript'"
                        [options]="editorOptions" (codeChange)="onCodeChange($event)" (ready)="onCodeEditorReady()">
                    </app-monaco-editor>
                    <textarea
                        *ngIf="!codeEditorReady()"
                        class="lite-editor editor-fill lite-overlay"
                        data-testid="js-code-editor"
                        [value]="editorContent()"
                        [attr.spellcheck]="false"
                        (input)="onCodeChange($any($event.target).value)"></textarea>
                </ng-container>
                <ng-template #liteCodeEditor>
                    <textarea
                        class="lite-editor editor-fill"
                        data-testid="js-code-editor"
                        [value]="editorContent()"
                        [attr.spellcheck]="false"
                        (input)="onCodeChange($any($event.target).value)"></textarea>
                </ng-template>
            </div>

            <!-- TESTS editor (kept mounted; toggled by display so it retains height) -->
            <div class="absolute inset-0" [style.display]="topTab()==='tests' ? 'block' : 'none'">
                <ng-container *ngIf="useMonaco(); else liteTestsEditor">
                    <app-monaco-editor #testsEditor class="h-full editor-fill" data-testid="js-tests-editor" [modelKey]="'q-' + question?.id + '-tests'"
                        [code]="testCode()" [language]="jsLang()==='ts' ? 'typescript' : 'javascript'"
                        [options]="editorOptions" (codeChange)="onTestsChange($event)" (ready)="onTestsEditorReady()">
                    </app-monaco-editor>
                    <textarea
                        *ngIf="!testsEditorReady()"
                        class="lite-editor editor-fill lite-overlay"
                        data-testid="js-tests-editor"
                        [value]="testCode()"
                        [attr.spellcheck]="false"
                        (input)="onTestsChange($any($event.target).value)"></textarea>
                </ng-container>
                <ng-template #liteTestsEditor>
                    <textarea
                        class="lite-editor editor-fill"
                        data-testid="js-tests-editor"
                        [value]="testCode()"
                        [attr.spellcheck]="false"
                        (input)="onTestsChange($any($event.target).value)"></textarea>
                </ng-template>
            </div>
        </div>

        <!-- SPLITTER between editors and results -->
        <div class="horizontal-splitter" data-testid="js-editor-splitter" [class.dragging]="isDraggingSplit()" (pointerdown)="startSplitDrag($event)">
        </div>

        <!-- BOTTOM: Actions + Results/Console -->
        <div class="flex-1 min-h-0 flex flex-col fa-runner-shell">
            <div class="fa-runner-topbar">
                <button class="fa-runner-run-btn" data-testid="js-run-tests" (click)="runTests()"
                    [disabled]="!(testCode()||'').trim() || isRunningTests()">▶ Run tests</button>
                <button class="fa-runner-tab-btn" [class.active]="subTab()==='tests'"
                    (click)="subTab.set('tests')">Results</button>
                <button class="fa-runner-tab-btn" [class.active]="subTab()==='console'"
                    (click)="subTab.set('console')">Console</button>
                <span class="fa-runner-summary" *ngIf="isRunningTests()">Running…</span>
                <span class="fa-runner-summary" *ngIf="!isRunningTests() && hasRunTests()">{{ passedCount() }}/{{ totalCount() }} passed</span>
            </div>

            <div class="flex-1 min-h-0 overflow-hidden">
                <!-- Results -->
                <div *ngIf="subTab()==='tests'" class="h-full overflow-auto p-4 results-panel fa-results" data-testid="js-results-panel">
                    <div *ngIf="!hasRunTests()" class="h-full grid place-items-center text-[11px] text-gray-400 empty-state">
                        {{ isRunningTests() ? 'Running tests…' : 'Run tests to see results.' }}
                    </div>

                    <div *ngIf="hasRunTests()" class="space-y-2">
                        <div class="summary mb-2">
                            <strong>{{ passedCount() }}</strong>/<strong>{{ totalCount() }}</strong> passed
                            <ng-container *ngIf="totalCount() > 0">
                                <span *ngIf="allPassing()" class="summary-pass">All tests passed ✓</span>
                                <span *ngIf="!allPassing()" class="summary-fail">Some tests failed</span>
                            </ng-container>
                        </div>

                        <div *ngFor="let t of testResults()" class="test-card" data-testid="test-result"
                            [ngClass]="t.passed ? 'test-pass' : 'test-fail'">
                            <div class="test-name">
                                <i [ngClass]="t.passed ? 'pi pi-check-circle' : 'pi pi-times-circle'"></i>
                                <span class="sr-only" data-testid="test-status">{{ t.passed ? 'PASS' : 'FAIL' }}</span>
                                <span>{{ t.name }}</span>
                            </div>
                            <div *ngIf="t.error" class="test-error whitespace-pre-wrap break-words">
                                {{ t.error }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Console -->
                <div *ngIf="subTab()==='console'" class="h-full overflow-auto p-3">
                    <app-console-logger class="console-panel block w-full h-full fa-results" [entries]="consoleEntries()"
                        [results]="testResults()" [max]="500" [autoScroll]="true"></app-console-logger>
                </div>

            </div>
        </div>
    </div>


</div>
