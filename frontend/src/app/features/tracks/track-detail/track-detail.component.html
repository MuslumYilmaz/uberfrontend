<ng-container *ngIf="track as t; else missing">
  <div class="track" [class.track--crash]="isCrashSevenDayTrack(t)" data-testid="track-detail-page">
    <div class="container">
      <nav class="breadcrumb">
        <a routerLink="/tracks">Tracks</a>
        <span>/</span>
        <span class="crumb-current">{{ t.title }}</span>
      </nav>

      <ng-container *ngIf="filtered$ | async as questions; else loadingTpl">
        <section faCard elevated class="fa-track-header">
          <div class="fa-track-header__left">
            <div class="fa-track-header__eyebrow fa-meta-label">Track</div>
            <h1 class="fa-track-header__title fa-page-title">{{ t.title }}</h1>
            <p class="fa-track-header__subtitle fa-body">{{ t.subtitle }}</p>
            <div class="fa-track-header__bullets" *ngIf="!isCrashSevenDayTrack(t); else crashHeaderDays">
              <span class="fa-track-header__bullet fa-chip fa-chip--label" *ngFor="let item of t.focus">{{ item }}</span>
            </div>
            <ng-template #crashHeaderDays>
              <div class="fa-track-header__bullets fa-track-header__bullets--days">
                <span class="fa-track-header__bullet fa-chip fa-chip--label" *ngFor="let day of crashDayLabels">{{ day }}</span>
              </div>
            </ng-template>
          </div>

          <div class="fa-track-header__right">
            <div class="fa-track-header__meta-row">
              <span class="meta-chip fa-chip fa-chip--accent">{{ t.durationLabel }}</span>
              <span class="meta-chip fa-chip fa-chip--accent">{{ questions.length }} questions</span>
            </div>
          </div>
        </section>

        <section faCard elevated class="fa-track-filters">
          <div class="filters-row">
            <div class="filter-group">
              <div class="filter-label fa-meta-label">Type</div>
              <div class="chip-row">
                <fa-chip size="md" class="filter-chip fa-chip--label" label="All"
                         testId="track-filter-kind-all"
                         [selected]="kindFilter$.value === 'all'"
                         (selectedChange)="onKindChange('all')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Coding"
                         testId="track-filter-kind-coding"
                         [selected]="kindFilter$.value === 'coding'"
                         (selectedChange)="onKindChange('coding')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Trivia"
                         testId="track-filter-kind-trivia"
                         [selected]="kindFilter$.value === 'trivia'"
                         (selectedChange)="onKindChange('trivia')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="System design"
                         testId="track-filter-kind-system-design"
                         [selected]="kindFilter$.value === 'system-design'"
                         (selectedChange)="onKindChange('system-design')">
                </fa-chip>
              </div>
            </div>

            <div class="filter-group">
              <div class="filter-label fa-meta-label">Tech</div>
              <div class="chip-row">
                <fa-chip size="md" class="filter-chip fa-chip--label" label="All tech"
                         testId="track-filter-tech-all"
                         [selected]="techFilter$.value === 'all'"
                         (selectedChange)="onTechChange('all')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="JavaScript"
                         testId="track-filter-tech-javascript"
                         [selected]="techFilter$.value === 'javascript'"
                         (selectedChange)="onTechChange('javascript')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="User interface"
                         testId="track-filter-tech-ui"
                         [selected]="techFilter$.value === 'ui'"
                         (selectedChange)="onTechChange('ui')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="HTML"
                         testId="track-filter-tech-html"
                         [selected]="techFilter$.value === 'html'"
                         (selectedChange)="onTechChange('html')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="CSS"
                         testId="track-filter-tech-css"
                         [selected]="techFilter$.value === 'css'"
                         (selectedChange)="onTechChange('css')">
                </fa-chip>
              </div>
            </div>

            <div class="filter-group">
              <div class="filter-label fa-meta-label">Difficulty</div>
              <div class="chip-row">
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Easy"
                         testId="track-filter-diff-easy"
                         [selected]="diffFilter$.value.has('easy')"
                         (selectedChange)="onDiffToggle('easy')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Intermediate"
                         testId="track-filter-diff-intermediate"
                         [selected]="diffFilter$.value.has('intermediate')"
                         (selectedChange)="onDiffToggle('intermediate')">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Hard"
                         testId="track-filter-diff-hard"
                         [selected]="diffFilter$.value.has('hard')"
                         (selectedChange)="onDiffToggle('hard')">
                </fa-chip>
              </div>
            </div>

            <div class="filter-group">
              <div class="filter-label fa-meta-label">Importance</div>
              <div class="chip-row">
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Low"
                         testId="track-filter-imp-low"
                         [selected]="impFilter$.value.has('low')"
                         (selectedChange)="onImportanceChange({ tier: 'low', checked: $event })">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="Medium"
                         testId="track-filter-imp-medium"
                         [selected]="impFilter$.value.has('medium')"
                         (selectedChange)="onImportanceChange({ tier: 'medium', checked: $event })">
                </fa-chip>
                <fa-chip size="md" class="filter-chip fa-chip--label" label="High"
                         testId="track-filter-imp-high"
                         [selected]="impFilter$.value.has('high')"
                         (selectedChange)="onImportanceChange({ tier: 'high', checked: $event })">
                </fa-chip>
              </div>
            </div>
          </div>

          <div class="filters-row filters-row--bottom">
            <div class="filter-group filter-group--search">
              <div class="filter-label fa-meta-label">Search</div>
              <div class="search-box fa-input">
                <i class="pi pi-search"></i>
                <input
                  type="text"
                  pInputText
                  placeholder="Search in this track"
                  data-testid="track-filter-search"
                  [(ngModel)]="searchTerm"
                  (ngModelChange)="onSearch($event)"
                  [ngModelOptions]="{ standalone: true }" />
              </div>
            </div>

            <div class="filter-group filter-group--sort">
              <div class="filter-label fa-meta-label">Sort</div>
              <div class="fa-input sort-select">
                <select data-testid="track-filter-sort" [ngModel]="sort$.value" (ngModelChange)="setSort($event)">
                  <option *ngFor="let opt of sortOptions" [value]="opt.key">{{ opt.label }}</option>
                </select>
              </div>
            </div>
          </div>
        </section>

        <ng-container *ngIf="isCrashSevenDayTrack(t)">
          <nav class="crash-day-rail" aria-label="7-day crash plan" *ngIf="crashDayViews$ | async as dayViews">
            <button
              type="button"
              class="crash-day-rail__item"
              *ngFor="let day of dayViews"
              [class.crash-day-rail__item--active]="day.day === activeCrashDay"
              (click)="setActiveCrashDay(day.day)">
              <span class="crash-day-rail__title">{{ day.label }}</span>
              <span class="crash-day-rail__meta">{{ day.visibleCount }}/{{ day.totalCount }} shown</span>
            </button>
          </nav>
        </ng-container>

        <ng-container *ngIf="isCrashSevenDayTrack(t); else standardTrackQuestions">
          <ng-container *ngIf="crashDayViews$ | async as dayViews">
            <ng-container *ngIf="activeCrashDayView(dayViews) as activeDay">
              <section class="fa-track-questions fa-track-questions--day-mode">
                <div class="list-head">
                  <div class="list-title">
                    <span class="list-kicker fa-meta-label">{{ activeDay.label }}</span>
                    <span class="count" data-testid="track-filtered-count">{{ activeDay.items.length }}</span>
                  </div>
                  <div class="note">Daily sprint board aligned to the 7-day crash route.</div>
                </div>

                <a
                  faCard interactive class="fa-question-card fa-question-card--compact"
                  *ngFor="let item of activeDay.items; let idx = index"
                  [attr.data-testid]="'track-question-card-' + item.id"
                  [routerLink]="linkFor(item)"
                  [state]="navState(activeDay.items, item)">
                  <div class="fa-question-card__grid">
                    <div class="fa-question-card__main">
                      <div class="fa-question-card__eyebrow">
                        <span class="eyebrow-dot"></span>
                        <span>{{ activeDay.label }} · Question {{ idx + 1 }} / {{ activeDay.items.length }}</span>
                        <span class="solved-pill" *ngIf="isSolved(item.id)">Solved</span>
                      </div>
                      <div class="fa-question-card__title fa-card-title">{{ item.title }}</div>
                      <div class="fa-question-card__description fa-meta-text" *ngIf="item.description">
                        {{ preview(item.description, 160) }}
                      </div>

                      <div class="framework-switcher" *ngIf="frameworkOptions(item).length > 1">
                        <div class="fw-label-row">
                          <span class="fw-label">Framework versions</span>
                          <span class="fw-hint">Open in your stack</span>
                        </div>
                        <div class="fw-chip-row">
                          <button
                            type="button"
                            class="fw-chip"
                            *ngFor="let opt of frameworkOptions(item)"
                            [class.active]="opt.id === item.id"
                            (click)="goToFramework($event, opt)">
                            <span class="fw-chip-label">{{ frameworkLabel(opt.tech) }}</span>
                            <span class="fw-cta">Open</span>
                          </button>
                        </div>
                      </div>
                    </div>

                    <div class="fa-question-card__meta-row">
                      <div class="fa-question-card__meta-item">
                        <span class="fa-meta-label">Difficulty</span>
                        <span class="fa-chip fa-chip--difficulty" [attr.data-difficulty]="(item.difficulty || 'intermediate').toLowerCase()">
                          {{ displayDifficulty(item.difficulty) }}
                        </span>
                      </div>

                      <div class="fa-question-card__meta-item">
                        <span class="fa-meta-label">Importance</span>
                        <span
                          class="fa-chip fa-chip--importance"
                          [attr.data-importance]="(item.importance ?? 0) >= 4 ? 'high' : (item.importance ?? 0) >= 2 ? 'medium' : 'low'">
                          {{ (item.importance ?? 0) >= 4 ? 'High' : (item.importance ?? 0) >= 2 ? 'Medium' : 'Low' }}
                        </span>
                      </div>

                      <div class="fa-question-card__meta-item" *ngIf="item.tech">
                        <span class="fa-meta-label">Tech</span>
                        <span class="fa-chip fa-chip--tech">
                          <span class="chip-icon" aria-hidden="true">⟡</span>
                          {{ item.tech | titlecase }}
                        </span>
                      </div>

                      <span class="ghost-link meta-open meta-open-pill">Open</span>
                    </div>
                  </div>
                </a>

                <div class="empty-day" *ngIf="!activeDay.items.length">
                  No questions match current filters for {{ activeDay.label }}.
                </div>
              </section>
            </ng-container>
          </ng-container>
        </ng-container>

        <ng-template #standardTrackQuestions>
          <section class="fa-track-questions">
            <div class="list-head">
              <div class="list-title">
                <span class="list-kicker fa-meta-label">Track questions</span>
                <span class="count" data-testid="track-filtered-count">{{ questions.length }}</span>
              </div>
              <div class="note">Pace yourself — no daily check-ins.</div>
            </div>

            <a
              faCard interactive class="fa-question-card fa-question-card--compact"
              *ngFor="let item of questions; let idx = index"
              [attr.data-testid]="'track-question-card-' + item.id"
              [routerLink]="linkFor(item)"
              [state]="navState(questions, item)">
              <div class="fa-question-card__grid">
                <div class="fa-question-card__main">
                  <div class="fa-question-card__eyebrow">
                    <span class="eyebrow-dot"></span>
                    <span>Track question {{ idx + 1 }} / {{ questions.length }}</span>
                    <span class="solved-pill" *ngIf="isSolved(item.id)">Solved</span>
                  </div>
                  <div class="fa-question-card__title fa-card-title">{{ item.title }}</div>
                  <div class="fa-question-card__description fa-meta-text" *ngIf="item.description">
                    {{ preview(item.description, 160) }}
                  </div>

                  <div class="framework-switcher" *ngIf="frameworkOptions(item).length > 1">
                    <div class="fw-label-row">
                      <span class="fw-label">Framework versions</span>
                      <span class="fw-hint">Open in your stack</span>
                    </div>
                    <div class="fw-chip-row">
                      <button
                        type="button"
                        class="fw-chip"
                        *ngFor="let opt of frameworkOptions(item)"
                        [class.active]="opt.id === item.id"
                        (click)="goToFramework($event, opt)">
                        <span class="fw-chip-label">{{ frameworkLabel(opt.tech) }}</span>
                        <span class="fw-cta">Open</span>
                      </button>
                    </div>
                  </div>
                </div>

                <div class="fa-question-card__meta-row">
                  <div class="fa-question-card__meta-item">
                    <span class="fa-meta-label">Difficulty</span>
                    <span class="fa-chip fa-chip--difficulty" [attr.data-difficulty]="(item.difficulty || 'intermediate').toLowerCase()">
                      {{ displayDifficulty(item.difficulty) }}
                    </span>
                  </div>

                  <div class="fa-question-card__meta-item">
                    <span class="fa-meta-label">Importance</span>
                    <span
                      class="fa-chip fa-chip--importance"
                      [attr.data-importance]="(item.importance ?? 0) >= 4 ? 'high' : (item.importance ?? 0) >= 2 ? 'medium' : 'low'">
                      {{ (item.importance ?? 0) >= 4 ? 'High' : (item.importance ?? 0) >= 2 ? 'Medium' : 'Low' }}
                    </span>
                  </div>

                  <div class="fa-question-card__meta-item" *ngIf="item.tech">
                    <span class="fa-meta-label">Tech</span>
                    <span class="fa-chip fa-chip--tech">
                      <span class="chip-icon" aria-hidden="true">⟡</span>
                      {{ item.tech | titlecase }}
                    </span>
                  </div>

                  <span class="ghost-link meta-open meta-open-pill">Open</span>
                </div>
              </div>
            </a>
          </section>
        </ng-template>
      </ng-container>

      <ng-template #loadingTpl>
        <div class="py-10 flex flex-col items-center gap-3" role="status" aria-live="polite" data-testid="track-detail-loading">
          <fa-spinner styleClass="text-blue-500" label="Loading track questions"></fa-spinner>
          <div class="text-sm opacity-80">Loading track questions…</div>
        </div>
      </ng-template>
    </div>
  </div>
</ng-container>

<ng-template #missing>
  <div class="track">
    <div class="container">
      <a class="breadcrumb" routerLink="/tracks">← All tracks</a>
      <h1>Track not found</h1>
      <p class="fa-track-header__subtitle">Pick a track from the list to see its question set.</p>
    </div>
  </div>
</ng-template>
