<ng-container *ngIf="!locked(); else lockedView">
<div class="sdl-root">
    <div class="sdl-main">
        <!-- LEFT : fixed rail -->
        <aside class="sdl-left">
            <div class="left-inner">
                <div class="left-head">
                    <div class="title-row">
                        <h1 class="title" [title]="title()">{{ title() }}</h1>
                        <button
                            class="report-issue-btn"
                            type="button"
                            data-testid="system-design-report-issue-btn"
                            (click)="reportIssue()"
                            aria-label="Report issue on this question">
                            <i class="fa-solid fa-bug" aria-hidden="true"></i>
                            <span class="report-issue-btn__label">Report issue</span>
                        </button>
                    </div>
                    <div class="title-meta">
                        By {{ authorLabel(q()) }}
                        <ng-container *ngIf="updatedLabel(q()) as updated"> · Updated {{ updated }}</ng-container>
                    </div>
                </div>

                <div class="left-body">
                    <div class="desc">{{ description() }}</div>
                    <div class="tags">
                        <p-chip *ngFor="let tag of tags(); trackBy: trackByTagValue" [label]="tag" styleClass="custom-chip"></p-chip>
                    </div>
                </div>

                <div class="left-foot">
                    <div class="guide">
                        New to RADIO?
                        <a routerLink="/guides/system-design-blueprint/radio-framework">Read the guide</a> first.
                    </div>
                    <details class="guide-collapsible">
                        <summary class="guide-summary">Guides</summary>
                        <div class="guide-links">
                            <a routerLink="/guides/system-design-blueprint/intro">System design: what it tests</a>
                            <a routerLink="/guides/system-design-blueprint/framework">Reusable 5‑step approach</a>
                            <a routerLink="/guides/system-design-blueprint/performance">Performance & Web Vitals</a>
                            <a routerLink="/guides/system-design-blueprint/state-data">State & caching patterns</a>
                        </div>
                    </details>
                </div>
            </div>
        </aside>

        <!-- CENTER : article -->
        <main class="sdl-center" #centerEl>
            <section class="sdl-mobile-controls" *ngIf="sections().length">
                <button
                    type="button"
                    class="sdl-mobile-trigger"
                    data-testid="sd-mobile-overview-trigger"
                    [attr.aria-expanded]="mobileOverviewOpen()"
                    aria-controls="sd-mobile-overview-panel"
                    (click)="toggleMobileOverview()">
                    <i class="fa-solid fa-circle-info" aria-hidden="true"></i>
                    <span>Overview</span>
                </button>
                <button
                    type="button"
                    class="sdl-mobile-trigger"
                    data-testid="sd-mobile-toc-trigger"
                    [attr.aria-expanded]="mobileTocOpen()"
                    aria-controls="sd-mobile-toc-panel"
                    (click)="toggleMobileToc()">
                    <i class="fa-solid fa-list" aria-hidden="true"></i>
                    <span>On this page</span>
                </button>
            </section>

            <div
                class="sdl-mobile-backdrop"
                data-testid="sd-mobile-backdrop"
                *ngIf="mobileOverviewOpen() || mobileTocOpen()"
                (click)="closeMobilePanels()"
                aria-hidden="true">
            </div>

            <section
                id="sd-mobile-overview-panel"
                class="sdl-mobile-panel"
                data-testid="sd-mobile-overview-panel"
                *ngIf="mobileOverviewOpen()"
                role="dialog"
                aria-label="Question overview">
                <div class="sdl-mobile-panel-head">
                    <div class="sdl-mobile-panel-title">Overview</div>
                    <button
                        type="button"
                        class="sdl-mobile-panel-close"
                        data-testid="sd-mobile-overview-close"
                        (click)="closeMobileOverview()"
                        aria-label="Close overview panel">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                    </button>
                </div>

                <div class="sdl-mobile-overview-body">
                    <div class="title-row">
                        <h1 class="title" [title]="title()">{{ title() }}</h1>
                        <button
                            class="report-issue-btn"
                            type="button"
                            data-testid="system-design-report-issue-btn-mobile"
                            (click)="reportIssue()"
                            aria-label="Report issue on this question">
                            <i class="fa-solid fa-bug" aria-hidden="true"></i>
                            <span class="report-issue-btn__label">Report issue</span>
                        </button>
                    </div>
                    <div class="title-meta">
                        By {{ authorLabel(q()) }}
                        <ng-container *ngIf="updatedLabel(q()) as updated"> · Updated {{ updated }}</ng-container>
                    </div>
                    <div class="desc">{{ description() }}</div>
                    <div class="tags">
                        <p-chip *ngFor="let tag of tags(); trackBy: trackByTagValue" [label]="tag" styleClass="custom-chip"></p-chip>
                    </div>
                    <details class="guide-collapsible">
                        <summary class="guide-summary">Guides</summary>
                        <div class="guide-links">
                            <a [routerLink]="radioGuideRoute()">System design blueprint</a>
                            <a routerLink="/guides/system-design-blueprint/intro">System design: what it tests</a>
                            <a routerLink="/guides/system-design-blueprint/framework">Reusable 5‑step approach</a>
                            <a routerLink="/guides/system-design-blueprint/performance">Performance & Web Vitals</a>
                            <a routerLink="/guides/system-design-blueprint/state-data">State & caching patterns</a>
                        </div>
                    </details>
                </div>
            </section>

            <section
                id="sd-mobile-toc-panel"
                class="sdl-mobile-panel sdl-mobile-panel--toc"
                data-testid="sd-mobile-toc-panel"
                *ngIf="mobileTocOpen()"
                role="dialog"
                aria-label="Page sections">
                <div class="sdl-mobile-panel-head">
                    <div class="sdl-mobile-panel-title">On this page</div>
                    <button
                        type="button"
                        class="sdl-mobile-panel-close"
                        data-testid="sd-mobile-toc-close"
                        (click)="closeMobileToc()"
                        aria-label="Close table of contents panel">
                        <i class="fa-solid fa-xmark" aria-hidden="true"></i>
                    </button>
                </div>
                <ul class="toc-list sdl-mobile-toc-list">
                    <li *ngFor="let s of sections(); trackBy: trackBySectionKey">
                        <button class="toc-item" [class.active]="activeKey()===s.key" (click)="scrollToKey(s.key)">
                            {{ s.title }}
                        </button>
                    </li>
                </ul>
            </section>

            <ng-container *ngFor="let s of sections(); trackBy: trackBySectionKey">
                <section class="sd-section" [attr.id]="anchorId(s.key)">
                    <h2 class="sd-h2" #sectionHeading [attr.data-key]="s.key">{{ s.title }}</h2>

                    <div class="sd-blocks">
                        <ng-container *ngIf="s.blocks?.length; else legacyText">
                            <ng-container *ngFor="let b of s.blocks; let bi = index; trackBy: trackByBlock">
                                <ng-container
                                    *ngTemplateOutlet="renderBlock; context: { $implicit: b, sectionKey: s.key, index: bi }">
                                </ng-container>
                            </ng-container>
                        </ng-container>

                        <ng-template #legacyText>
                            <div class="sd-text">{{ s.content }}</div>
                        </ng-template>
                    </div>

                    <ng-template #renderBlock let-b let-sectionKey="sectionKey" let-idx="index">
                        <!-- TEXT -->
                        <div *ngIf="b.type === 'text'" class="sd-text">{{ b.text }}</div>

                        <!-- DIVIDER -->
                        <div *ngIf="b.type === 'divider'" class="sd-divider"></div>

                        <!-- CODE (Monaco, lazy) -->
                        <div *ngIf="b.type === 'code'" class="sd-code"
                            [style.minHeight.px]="!isCodeMounted(codeKey(sectionKey, idx)) ? (b.height || 160) : (b.height || null)">
                            <div *ngIf="!isCodeMounted(codeKey(sectionKey, idx)); else showCode" #codeSentinel
                                class="code-sentinel" [attr.data-code-id]="codeKey(sectionKey, idx)">
                            </div>

                            <ng-template #showCode>
                                <app-monaco-editor class="sd-code-fill" [code]="b.code"
                                    [language]="b.language || 'typescript'" [readOnly]="true" [interactive]="false"
                                    [autoHeight]="!b.height" [options]="codeViewerOptions"
                                    [style.height.px]="b.height || null">
                                </app-monaco-editor>
                            </ng-template>
                        </div>

                        <!-- IMAGE -->
                        <figure *ngIf="b.type === 'image'" class="sd-figure">
                            <picture>
                                <source *ngIf="b.srcAvif" [attr.srcset]="asset(b.srcAvif)" type="image/avif" />
                                <source *ngIf="b.srcWebp" [attr.srcset]="asset(b.srcWebp)" type="image/webp" />
                                <img [src]="asset(b.src)" [alt]="b.alt || ''" [attr.width]="b.width || null"
                                    [attr.height]="b.height || null" [attr.loading]="b.priority ? 'eager' : 'lazy'"
                                    [attr.decoding]="b.priority ? 'sync' : 'async'" />
                            </picture>
                            <figcaption *ngIf="b.caption">{{ b.caption }}</figcaption>
                        </figure>

                        <!-- CHECKLIST -->
                        <div *ngIf="b.type === 'checklist'" class="sd-checklist">
                            <div class="sd-checklist-title" *ngIf="b.title">
                                {{ b.title }}
                            </div>
                            <ul class="sd-checklist-list">
                                <li *ngFor="let item of b.items; trackBy: trackByStringValue">
                                    <span class="sd-checklist-bullet"></span>
                                    <span class="sd-checklist-text">{{ item }}</span>
                                </li>
                            </ul>
                        </div>

                        <!-- CALLOUT -->
                        <div *ngIf="b.type === 'callout'" class="sd-callout"
                            [class.sd-callout-info]="!b.variant || b.variant === 'info'"
                            [class.sd-callout-success]="b.variant === 'success'"
                            [class.sd-callout-warning]="b.variant === 'warning'"
                            [class.sd-callout-danger]="b.variant === 'danger'">
                            <div class="sd-callout-title" *ngIf="b.title">
                                {{ b.title }}
                            </div>
                            <div class="sd-callout-text">
                                {{ b.text }}
                            </div>
                        </div>

                        <!-- TABLE -->
                        <div *ngIf="b.type === 'table'" class="sd-table">
                            <div class="sd-table-title" *ngIf="b.title">{{ b.title }}</div>
                            <table>
                                <thead>
                                    <tr>
                                        <th *ngFor="let col of b.columns; trackBy: trackByStringValue">{{ col }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let row of b.rows; trackBy: trackByTableRow">
                                        <td *ngFor="let cell of row; trackBy: trackByTableCell">{{ cell }}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- COLUMNS -->
                        <div *ngIf="b.type === 'columns'" class="sd-columns">
                            <div class="sd-column" *ngFor="let col of b.columns; let ci = index; trackBy: trackByColumnIndex"
                                [class.w-1-3]="col.width === '1/3'" [class.w-2-3]="col.width === '2/3'">
                                <ng-container *ngFor="let inner of col.blocks; let ii = index; trackBy: trackByInnerBlock">
                                    <ng-container
                                        *ngTemplateOutlet="renderBlock; context: { $implicit: inner, sectionKey: sectionKey, index: idx + '-' + ci + '-' + ii }">
                                    </ng-container>
                                </ng-container>
                            </div>
                        </div>

                        <!-- STATS -->
                        <div *ngIf="b.type === 'stats'" class="sd-stats">
                            <div class="sd-stat" *ngFor="let item of b.items; trackBy: trackByStatItem">
                                <div class="sd-stat-label">{{ item.label }}</div>
                                <div class="sd-stat-value">{{ item.value }}</div>
                                <div class="sd-stat-helper" *ngIf="item.helperText">{{ item.helperText }}</div>
                            </div>
                        </div>

                        <!-- STEPS -->
                        <div *ngIf="b.type === 'steps'" class="sd-steps">
                            <div class="sd-steps-title" *ngIf="b.title">{{ b.title }}</div>
                            <div class="sd-steps-row" [class.vertical]="b.steps?.length > 3">
                                <ng-container *ngFor="let step of b.steps; let si = index; trackBy: trackByStepTitle">
                                    <div class="sd-step">
                                        <div class="sd-step-circle">{{ si + 1 }}</div>
                                        <div class="sd-step-body">
                                            <div class="sd-step-title">{{ step.title }}</div>
                                            <div class="sd-step-text" *ngIf="step.text">{{ step.text }}</div>
                                        </div>
                                        <div class="sd-step-arrow" *ngIf="si < b.steps.length - 1">→</div>
                                    </div>
                                </ng-container>
                            </div>
                        </div>
                    </ng-template>
                </section>
            </ng-container>

            <section class="sd-related" *ngIf="relatedItems().length">
                <div class="sd-related-head">Similar questions</div>
                <div class="sd-related-list">
                    <a class="sd-related-item" *ngFor="let item of relatedItems(); trackBy: trackByRelatedId"
                        [routerLink]="['/system-design', item.id]">
                        <span class="sd-related-title">{{ item.title }}</span>
                        <span class="sd-related-pill" *ngIf="item.access === 'premium'">Premium</span>
                    </a>
                </div>
            </section>

            <section class="sd-guides">
                <div class="sd-related-head">Guides</div>
                <div class="sd-related-list">
                    <a class="sd-related-item" [routerLink]="['/guides/system-design-blueprint/intro']">
                        <span class="sd-related-title">Front‑End System Design: What It Tests</span>
                    </a>
                    <a class="sd-related-item" [routerLink]="['/guides/system-design-blueprint/framework']">
                        <span class="sd-related-title">Reusable 5‑Step Approach</span>
                    </a>
                    <a class="sd-related-item" [routerLink]="['/guides/system-design-blueprint/performance']">
                        <span class="sd-related-title">Performance & Web Vitals at Scale</span>
                    </a>
                </div>
            </section>

            <section class="sd-prep-bridge" data-testid="system-design-prep-entry">
                <div class="sd-related-head">Preparing for interviews?</div>
                <p class="sd-prep-bridge__text">
                    Use guided tracks for structured prep, then drill company-specific question sets when you need targeted practice.
                </p>
                <div class="sd-prep-bridge__links">
                    <a [routerLink]="['/tracks']">Explore interview tracks</a>
                    <a [routerLink]="['/companies']">Browse company questions</a>
                    <a [routerLink]="['/guides/framework-prep']">View framework prep paths</a>
                </div>
            </section>

        </main>

        <!-- RIGHT : fixed TOC -->
        <nav class="sdl-right">
            <div class="toc">
                <div class="toc-head">On this page</div>
                <ul class="toc-list">
                    <li *ngFor="let s of sections(); trackBy: trackBySectionKey">
                        <button class="toc-item" [class.active]="activeKey()===s.key" (click)="scrollToKey(s.key)">
                            {{ s.title }}
                        </button>
                    </li>
                </ul>
                <div class="toc-foot">
                    <button class="top-btn" (click)="scrollTop()">Back to top</button>
                </div>
            </div>
        </nav>
    </div>

    <app-footer mode="practice" [progressText]="progressText" [prevDisabled]="!hasPrev" [nextDisabled]="!hasNext"
        (prev)="onPrev()" (next)="onNext()">
    </app-footer>
</div>
</ng-container>

<ng-template #lockedView>
    <div class="locked-shell">
        <div class="locked-card">
            <div class="locked-pill">Premium</div>
            <h1 class="locked-title">{{ lockedTitle() }}</h1>
            <div class="locked-meta">
                By {{ authorLabel(q()) }}
                <ng-container *ngIf="updatedLabel(q()) as updated"> · Updated {{ updated }}</ng-container>
            </div>
            <div class="locked-preview" data-testid="premium-preview" *ngIf="lockedSummary() || lockedBullets().length">
                <p class="locked-preview__summary" *ngIf="lockedSummary()">{{ lockedSummary() }}</p>
                <ul class="locked-preview__list" *ngIf="lockedBullets().length">
                    <li *ngFor="let item of lockedBullets(); trackBy: trackByStringValue">{{ item }}</li>
                </ul>
            </div>
            <app-locked-preview *ngIf="lockedPreview()" [data]="lockedPreview()!"></app-locked-preview>
            <p class="locked-persona" *ngIf="lockedPersonalizationLine()">{{ lockedPersonalizationLine() }}</p>
            <div class="locked-related" *ngIf="relatedItems().length">
                <div class="locked-related__title">Related questions</div>
                <div class="locked-related__list">
                    <a class="locked-related__item" *ngFor="let item of relatedItems(); trackBy: trackByRelatedId"
                        [routerLink]="['/system-design', item.id]">
                        <span class="locked-related__text">{{ item.title }}</span>
                        <span class="locked-related__pill" *ngIf="item.access === 'premium'">Premium</span>
                    </a>
                </div>
            </div>
            <div class="locked-paths" *ngIf="lockedPaths().length">
                <a
                    class="locked-paths__item"
                    *ngFor="let path of lockedPaths(); trackBy: trackByLockedPath"
                    [routerLink]="path.route"
                    [queryParams]="path.queryParams"
                    (click)="trackLockedPathClick(path.id)">
                    <span>{{ path.label }}</span>
                    <i class="pi pi-arrow-right"></i>
                </a>
            </div>
            <p class="locked-copy">
                <ng-container *ngIf="auth.isLoggedIn(); else lockedGuest">
                    {{ lockedMemberCopy() }}
                </ng-container>
                <ng-template #lockedGuest>
                    {{ lockedGuestCopy() }}
                </ng-template>
            </p>
            <div class="locked-actions">
                <button class="fa-btn fa-btn--primary" type="button" (click)="goToPricingFromLocked()">View pricing</button>
                <button class="fa-btn fa-btn--ghost" type="button" data-testid="system-design-report-access-issue-btn" (click)="reportAccessIssue()">Report access issue</button>
                <button *ngIf="!auth.isLoggedIn()" class="fa-btn fa-btn--ghost" type="button" (click)="goToLoginFromLocked()">Sign in</button>
            </div>
        </div>
    </div>
</ng-template>
